<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Welcome</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Google Fonts (Poppins) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Internal Styles -->
    <style>
        :root {
            /* Color Palette */
            --primary-color: #f7c5ae;
            --primary-dark: #e9a992;
            --primary-light: #ffd7c7;
            --text-color: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --bg-dark: rgba(17, 25, 40, 0.7);
            --card-bg: rgba(17, 25, 40, 0.7);
            --task-card-bg: rgba(20, 30, 50, 0.75);

            /* Transitions */
            --transition-quick: 0.3s;

            /* Due Date Status Colors */
            --due-date-past: #e74c3c;
            --due-date-soon: #f39c12;
            --due-date-ok: gray;

            /* Timeline Styles */
            --timeline-line: rgba(247, 197, 174, 0.3);
            --timeline-dot: var(--primary-color);
            --timeline-dot-border: rgba(247, 197, 174, 0.5);
            --timeline-card: rgba(30, 40, 60, 0.8);
        }

        /* Global Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0f1729, #1a1b2f);
            background-size: 400% 400%;
            color: var(--text-color);
            position: relative;
            min-height: 100vh;
            animation: gradientBG 15s ease infinite;
            zoom: 0.9; 
        }

        /* Animated Gradient Background */
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Background Image Wrapper */
        .background-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
        }

        .moving-bg {
            position: absolute;
            width: 120%;
            height: 120%;
            top: -10%;
            left: -10%;
            background-image: url('https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1974&q=80');
            background-size: cover;
            background-position: center;
            filter: brightness(1) saturate(1.2);
            z-index: -1;
            will-change: transform;
            transform: translate3d(0, 0, 0);
            transition: transform 0.2s ease-out;
        }
        /* Header Styles */
        .header {
            position: sticky;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px 40px;
            background: var(--bg-dark);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Logo Styles */
        .logo {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 1.4rem;
        }
        /* User Info Section (Right side of header) */
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* User Profile Button */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50px;
            cursor: pointer;
            transition: all var(--transition-quick);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        /* User Avatar */
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #1a1b2f;
        }

        /* User Details (Name, Badge) - Hidden on smaller screens */
        .user-details {
            display: flex;
            flex-direction: column;
        }

        /* Username Display */
        .username {
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* User Badge (e.g., 'Admin') */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            font-size: 0.7rem;
            border-radius: 20px;
            background: rgba(247, 197, 174, 0.15);
            border: 1px solid rgba(247, 197, 174, 0.3);
            color: var(--primary-light);
        }

        /* Header Action Buttons Container */
        .actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* General Action Button Style (e.g., Logout) */
        .action-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all var(--transition-quick);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            color: var(--text-color);
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-2px);
        }

        /* Logout Button Specific Styles */
        .logout-btn {
            background: rgba(240, 100, 100, 0.15);
            color: rgba(255, 190, 190, 0.9);
            border: 1px solid rgba(240, 100, 100, 0.3);
        }

        .logout-btn:hover {
            background: rgba(240, 100, 100, 0.25);
            color: rgba(255, 210, 210, 1);
        }

        /* Pending Tasks Section */
        .tasks-section {
            max-width: 1568px;
            margin: 30px auto 0;
            padding: 25px 30px; 
            position: relative;
            z-index: 1;
            background: rgba(17, 25, 40, 0.6); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
            border-radius: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2); 
            transition: max-height 0.5s ease-in-out; 
        }

        /* Header within the Tasks Section */
        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        /* Actions within the Tasks Header (Refresh, Expand) */
        .tasks-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Refresh Tasks Button */
        .refresh-tasks-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-quick);
        }

        .refresh-tasks-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            transform: translateY(-2px);
        }

        .refresh-tasks-btn i {
            font-size: 1rem;
        }

        /* Spinning Animation for Refresh Button */
        .refresh-tasks-btn.spinning i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tasks Section Title */
        .tasks-header h2 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-color);
            margin: 0; 
            padding: 0; 
            border: none; 
            position: static; 
        }

        /* Underline effect for Tasks Section Title */
        .tasks-header h2::after {
            content: '';
            position: absolute;
            bottom: -1px; 
            left: 0;
            width: 60px;
            height: 2px;
            background: var(--primary-color);
        }

        /* Expand/Collapse Tasks Button */
        .expand-tasks-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            padding: 5px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-quick);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .expand-tasks-btn.hidden {
            display: none;
        }

        .expand-tasks-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-color);
        }

        .expand-tasks-btn i {
            transition: transform var(--transition-quick);
        }

        /* Wrapper for the Task Cards Carousel */
        .tasks-carousel-wrapper {
            position: relative;
            width: 100%;
            padding: 0 50px; 
            box-sizing: border-box;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; 
            max-height: 250px; 
            overflow: hidden; 
        }

        /* Container for the actual Task Cards (Flexbox) */
        #tasks-list-container {
            display: flex;
            overflow-x: auto; 
            overflow-y: hidden; 
            scroll-behavior: smooth;
            padding: 10px 0; 
            gap: 20px; 
            scrollbar-width: none; 
            -ms-overflow-style: none; 
            transition: flex-wrap 0.3s ease, max-height 0.5s ease-in-out; 
            flex-wrap: nowrap; 
        }

        /* Hide Scrollbar for Task Cards Container */
        #tasks-list-container::-webkit-scrollbar {
            display: none; 
        }

        /* Styles for Expanded Tasks Section: Carousel Wrapper */
        .tasks-section.expanded .tasks-carousel-wrapper {
            max-height: 600px; 
            padding: 0; 
            overflow-y: auto; 
             
            scrollbar-width: thin;
            scrollbar-color: rgba(247, 197, 174, 0.3) rgba(255, 255, 255, 0.05);
        }

        /* Styles for Expanded Tasks Section: Scrollbar */
         .tasks-section.expanded .tasks-carousel-wrapper::-webkit-scrollbar {
            width: 6px;
            display: block; 
        }

        .tasks-section.expanded .tasks-carousel-wrapper::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .tasks-section.expanded .tasks-carousel-wrapper::-webkit-scrollbar-thumb {
            background: rgba(247, 197, 174, 0.3);
            border-radius: 10px;
        }

        /* Styles for Expanded Tasks Section: Task List Container */
        .tasks-section.expanded #tasks-list-container {
            flex-wrap: wrap; 
            overflow-x: hidden; 
            overflow-y: visible; 
            max-height: none; 
        }

        /* Hide Carousel Arrows when Expanded */
        .tasks-section.expanded .carousel-arrow {
            display: none; 
        }

        /* Rotate Expand Button Icon when Expanded */
        .tasks-section.expanded .expand-tasks-btn i {
            transform: rotate(180deg); 
        }

        /* Individual Task Card Style */
        .task-card {
            background: var(--task-card-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            flex: 0 0 auto; 
            width: 336px; 
            min-height: 150px; 
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
        }

        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            border-color: rgba(255, 255, 255, 0.15);
        }

        /* Task Card Title */
        .task-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 15px; 
            line-height: 1.3;
        }

        /* Due Date Status Indicator Styles */
        .due-date-past {
            color: var(--due-date-past);
            background-color: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .due-date-soon {
            color: var(--due-date-soon);
            background-color: rgba(243, 156, 18, 0.1);
            border: 1px solid rgba(243, 156, 18, 0.3);
        }

        .due-date-ok {
            color: var(--due-date-ok);
            background-color: transparent;
            border: 1px solid var(--due-date-ok);
        }

        /* Task Feedback Section (within modal?) */
        .task-feedback strong {
            display: block;
            margin-bottom: 5px;
            color: var(--primary-light);
            font-size: 0.9rem;
        }

        .task-feedback p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Footer Section of a Task Card */
        .task-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto; 
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Reset margin for status/due date within the footer */
        .task-card-footer .task-status,
        .task-card-footer .task-due-date {
            margin-top: 0; 
        }

        /* Due Date Styling within Task Card Footer */
        .task-card-footer .task-due-date {
            font-size: 0.8rem;
            font-weight: 500;
            padding: 3px 8px;
            border-radius: 5px;
        }

        /* Main Content Container (holds the action cards grid) */
        .main-container {
            max-width: 1400px;
            margin: 30px auto; 
            padding: 0 30px;
            position: relative;
            z-index: 1;
        }

        /* Grid Layout for Action Cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 25px;
        }

        /* Individual Action Card Style */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            height: 100%;
            min-height: 200px;
            cursor: pointer;
            transform: translateY(0) scale(1);
        }

        /* Subtle Gradient Effect on Card */
        .card::before {
            content: '';
            position: absolute;
            top: -10%;
            left: -10%;
            width: 120%;
            height: 120%;
            background: radial-gradient(
                circle at top right,
                rgba(255, 255, 255, 0.1),
                transparent 60%
            );
            z-index: -1;
            pointer-events: none;
        }

        /* Action Card Hover Effects */
        .card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Content Area within an Action Card */
        .card-content {
            padding: 25px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Icon Styling within an Action Card */
        .card-icon {
            width: 50px;
            height: 50px;
            background: rgba(247, 197, 174, 0.15);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 1.5rem;
            transition: all var(--transition-quick);
            border: 1px solid rgba(247, 197, 174, 0.3);
        }

        /* Icon Hover Effect within an Action Card */
        .card:hover .card-icon {
            background: rgba(247, 197, 174, 0.25);
            transform: scale(1.1) rotate(5deg);
        }

        /* Title Styling within an Action Card */
        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        /* Description Styling within an Action Card */
        .card-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
            flex-grow: 1;
        }

        /* Action Text ("Add New", "Search Tasks") within an Action Card */
        .card-action {
            margin-top: 15px;
            display: flex;
            align-items: center;
            color: var(--primary-color);
            font-weight: 500;
            font-size: 0.9rem;
            transition: all var(--transition-quick);
            gap: 5px;
        }

        /* Action Text Hover Effect */
        .card:hover .card-action {
            gap: 10px;
        }

        /* Responsive Design: Media Queries */
        @media (max-width: 1200px) {
            .cards-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 992px) {
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
                flex-direction: row; 
                justify-content: space-between; 
                align-items: center; 
                gap: 15px;
            }

            .logo span {
                font-size: 1.2rem;
            }

            .user-info {
                gap: 15px;
            }

            .tasks-section {
                 padding: 0 15px;
                 margin: 20px auto 0;
            }
            .tasks-carousel-wrapper {
                 padding: 0 40px;
            }
             #tasks-list-container {
                 gap: 15px;
             }
             .task-card {
                 width: 320px;
             }

            .main-container {
                padding: 0 20px;
                margin: 20px auto;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            /* Adjust user profile display on small screens */
            .user-profile {
                padding: 5px;
                background: transparent;
                border: none;
            }

            .user-profile .user-details {
                display: none; /* Hide username/badge */
            }

            .actions {
                margin-top: 0;
            }

            /* Stack task details columns vertically */
            .task-details-columns {
                flex-direction: column;
            }

            .task-details-column {
                width: 100%;
                max-width: 100%;
            }

            .task-history-column {
                margin-top: 25px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                border-left: none;
                padding-top: 25px;
                padding-left: 0;
                padding-right: 30px;
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000; /* Ensure modal is on top */
            display: none; /* Hidden by default */
            overflow: hidden;
            transform: translateZ(0); /* Improve rendering performance */
        }

        /* Active Modal State */
        .modal.active {
            display: block;
            animation: fadeIn 0.3s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Modal Backdrop (Overlay) */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 101;
        }

        /* Modal Content Container */
        .modal-container {
            position: absolute;
            z-index: 102;
            width: 90%;
            max-width: 650px;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -55%) scale(0.95);
            background: linear-gradient(135deg, rgba(25, 35, 60, 0.95), rgba(15, 23, 42, 0.97));
            backdrop-filter: blur(20px);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5),
                        0 0 100px rgba(247, 197, 174, 0.15),
                        inset 0 1px 1px rgba(255, 255, 255, 0.1);
            overflow: hidden;
            opacity: 0;
            animation: modalOpen 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes modalOpen {
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes slideIn {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Modal Header */
        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, rgba(22, 32, 50, 0.98), rgba(15, 23, 42, 0.98));
            position: relative;
        }

        /* Subtle Gradient Line below Modal Header */
        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 5%;
            width: 90%;
            height: 1px;
            background: linear-gradient(to right,
                transparent,
                rgba(247, 197, 174, 0.3),
                transparent
            );
        }

        /* Modal Title */
        .modal-header h3 {
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
            background: linear-gradient(to right, var(--text-color), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Modal Body */
        .modal-body {
            padding: 22px 30px;
            /* Custom Scrollbar for Modal Body */
            scrollbar-width: thin;
            scrollbar-color: rgba(247, 197, 174, 0.3) rgba(255, 255, 255, 0.05);
        }

        .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: rgba(247, 197, 174, 0.3);
            border-radius: 10px;
        }

        /* General Form Control Styling within Modals */
        .modal .form-control {
            background-color: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: var(--text-color);
            padding: 12px 16px;
            border-radius: 12px;
            width: 100%;
            font-family: 'Poppins', sans-serif;
            font-size: 0.92rem;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) inset;
        }

        .modal .form-control:focus {
            background: linear-gradient(to right, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.03));
            border-color: rgba(247, 197, 174, 0.4);
            box-shadow: 0 0 0 3px rgba(247, 197, 174, 0.15),
                        0 4px 8px rgba(0, 0, 0, 0.1) inset;
            outline: none;
        }

        /* Styling for Autofilled Inputs in Webkit Browsers */
        .modal .form-control:-webkit-autofill,
        .modal .form-control:-webkit-autofill:hover,
        .modal .form-control:-webkit-autofill:focus,
        .modal .form-control:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px rgba(25, 35, 60, 0.95) inset !important;
            -webkit-text-fill-color: var(--text-color) !important;
            transition: background-color 5000s ease-in-out 0s;
            background-clip: content-box !important;
            border-color: rgba(247, 197, 174, 0.4) !important;
        }

        /* General Autofill Styles (Redundant? Check if needed) */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px rgba(25, 35, 60, 0.95) inset !important;
            -webkit-text-fill-color: var(--text-color) !important;
            transition: background-color 5000s ease-in-out 0s;
            background-clip: content-box !important;
        }

        /* Row Layout for Form Groups */
        .modal .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 18px; /* Add margin to the row itself */
        }

        /* Individual Form Group */
        .modal .form-group {
            width: 100%;
            margin-bottom: 18px;
        }

        /* Half-width Form Group within a Form Row */
        .modal .form-group.half {
            flex: 1; /* Take up equal space */
            margin-bottom: 0; /* Remove bottom margin as row has it */
        }

        /* Form Label Styling */
        .modal label {
            display: block;
            margin-bottom: 10px;
            font-size: 0.95rem;
            color: var(--text-secondary);
            font-weight: 500;
            letter-spacing: 0.3px;
            /* Gradient effect for label text */
            background: linear-gradient(to right, var(--text-color), var(--text-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Required Field Indicator (*) */
        .modal label .required {
            color: var(--primary-color);
            margin-left: 3px;
            /* Reset gradient effect for the asterisk */
            -webkit-background-clip: initial;
            background-clip: initial;
            -webkit-text-fill-color: initial;
        }

        /* Container for Modal Action Buttons (Cancel, Submit) */
        .modal .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
        }

        /* Subtle Gradient Line above Form Actions */
        .modal .form-actions::before {
            content: '';
            position: absolute;
            top: 0;
            left: 5%;
            width: 90%;
            height: 1px;
            background: linear-gradient(to right,
                transparent,
                rgba(247, 197, 174, 0.2),
                transparent
            );
        }

        /* Secondary Button Style (e.g., Cancel) */
        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 24px; 
            border-radius: 12px;
            font-weight: 500;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.03);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        /* Primary Button Style (e.g., Submit, Add) */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: #1a1b2f;
            border: none;
            padding: 12px 24px; 
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 20px rgba(233, 169, 146, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        /* Shimmer Effect on Primary Button */
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.6s;
            z-index: -1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(233, 169, 146, 0.4);
            background: linear-gradient(135deg, #f8d1be, #eaae99);
        }

         .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:active {
            transform: translateY(1px);
        }

        /* Invalid Form Control Styling */
        .modal .form-control.invalid {
            border-color: rgba(255, 99, 99, 0.5);
            background-color: rgba(255, 99, 99, 0.08);
        }

        /* Error Message Styling */
        .error-message {
            color: #ff8c8c;
            font-size: 0.85rem;
            margin-top: 8px;
            display: none;
            opacity: 0;
            transform: translateY(-5px);
            transition: all 0.3s;
        }

        /* Visible Error Message State */
        .error-message.visible {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        /* Wrapper for Input and Icon */
        .input-wrapper {
            position: relative;
        }

        /* Icon Styling within Input Wrapper */
        .input-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            opacity: 0.5;
            transition: all 0.3s;
            cursor: pointer; 
            pointer-events: none; 
        }

        /* Make icon clickable (e.g., calendar) */
        .input-icon.clickable {
            pointer-events: auto;
        }

        /* Icon Style on Input Focus */
        .form-control:focus + .input-icon {
            color: var(--primary-color);
            opacity: 1;
        }

        /* Fade-in Animation for Modal Backdrop */
        .modal.active .modal-backdrop {
            animation: backdropFadeIn 0.3s forwards;
        }

        @keyframes backdropFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Specific Styling for Date Inputs in Modals */
        .modal input[type="date"].form-control {
            background-color: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: var(--text-color); 
            padding: 12px 16px;
            border-radius: 12px;
            width: 100%;
            font-family: 'Poppins', sans-serif;
            font-size: 0.92rem;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) inset;
            
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            position: relative;
             padding-right: 40px; 
        }

        .modal input[type="date"].form-control:focus {
            background: linear-gradient(to right, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.03));
            border-color: rgba(247, 197, 174, 0.4); 
            box-shadow: 0 0 0 3px rgba(247, 197, 174, 0.15),
                        0 4px 8px rgba(0, 0, 0, 0.1) inset;
            outline: none;
        }

        /* Styling the Default Calendar Picker Indicator (Webkit) */
        .modal input[type="date"].form-control::-webkit-calendar-picker-indicator {
             filter: grayscale(100%) invert(1) brightness(0.7); 
             opacity: 0; 
             position: absolute;
             right: 15px;
             top: 50%;
             transform: translateY(-50%);
             width: 20px;
             height: 20px;
             cursor: pointer;
        }

        /* Make the custom calendar icon clickable */
         .input-wrapper .input-icon.fa-calendar {
            pointer-events: auto; 
            cursor: pointer;
         }

        /* Set dark color scheme for date picker UI */
        .modal input[type="date"].form-control {
            color-scheme: dark;
        }

        /* Specific Styling for Select Dropdowns in Modals */
        .modal select.form-control {
             background-color: rgba(255, 255, 255, 0.03);
             color: var(--text-color);
             appearance: none;
             -webkit-appearance: none;
             -moz-appearance: none;
             cursor: pointer;
             padding-right: 40px; 
             background-image: none; 
        }

        /* Styling for Options within the Select Dropdown */
        .modal select.form-control option {
            background-color: rgba(25, 35, 60, 1); 
            color: var(--text-color);
            padding: 12px;
        }

        /* Styling for the Custom Select Arrow Icon */
        .modal .input-wrapper .input-icon.select-arrow {
            pointer-events: none; 
            right: 15px; 
        }

        /* Focus Styling for Select Dropdowns */
        .modal select.form-control:focus {
             background: linear-gradient(to right, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.03));
             border-color: rgba(247, 197, 174, 0.4);
             box-shadow: 0 0 0 3px rgba(247, 197, 174, 0.15),
                         0 4px 8px rgba(0, 0, 0, 0.1) inset;
        }

        /* Animation for Modal Content Elements */
        @keyframes slideUpFadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Initially Hide Modal Form Elements for Animation */
        .modal-body .form-row,
        .modal-body .form-group:not(.half) {
            opacity: 0;
        }

        /* Apply Animation when Modal is Active */
        .modal.active .modal-body .form-row,
        .modal.active .modal-body .form-group:not(.half) {
            animation: slideUpFadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        /* Staggered Animation Delays for Form Elements */
        .modal.active .modal-body .form-row:nth-child(1),
        .modal.active .modal-body .form-group:nth-child(1) { animation-delay: 0.1s; }
        .modal.active .modal-body .form-row:nth-child(2),
        .modal.active .modal-body .form-group:nth-child(2) { animation-delay: 0.15s; }
        .modal.active .modal-body .form-row:nth-child(3),
        .modal.active .modal-body .form-group:nth-child(3) { animation-delay: 0.2s; }
        .modal.active .modal-body .form-row:nth-child(4),
        .modal.active .modal-body .form-group:nth-child(4) { animation-delay: 0.25s; }
        .modal.active .modal-body .form-row:nth-child(5),
        .modal.active .modal-body .form-group:nth-child(5) { animation-delay: 0.3s; }
        .modal.active .modal-body .form-row:nth-child(6),
        .modal.active .modal-body .form-group:nth-child(6) { animation-delay: 0.35s; }


        /* Animate Form Actions */
        .modal-body .form-actions {
             opacity: 0;
        }
        .modal.active .modal-body .form-actions {
            animation: slideUpFadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            animation-delay: 0.4s;
        }

        /* Notifications Area */
        .notifications-container {
            position: fixed;
            top: 80px; 
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 320px; 
        }

        /* Individual Notification Style */
        .notification {
            padding: 15px 20px; 
            border-radius: 10px;
            background: rgba(20, 30, 50, 0.9); 
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            color: var(--text-color);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 15px; 
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s ease; 
            opacity: 0;
        }

        /* Visible Notification State */
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        /* Notification Types (Info, Success, Error) */
        .notification.info {
            border-left: 4px solid #3498db;
        }

        .notification.success {
            border-left: 4px solid #2ecc71;
        }

        .notification.error {
            border-left: 4px solid #e74c3c;
        }

        /* Notification Icon */
        .notification-icon {
            font-size: 1.3rem; 
            flex-shrink: 0; 
        }

        /* Icon Colors based on Notification Type */
        .notification.info .notification-icon {
            color: #3498db;
        }

        .notification.success .notification-icon {
            color: #2ecc71;
        }

        .notification.error .notification-icon {
            color: #e74c3c;
        }

        /* Notification Text Content */
        .notification-content {
            flex: 1;
            line-height: 1.4; 
        }

        /* Task Carousel Arrow Buttons */
        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-secondary);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 5;
            font-size: 1rem;
        }

        .carousel-arrow:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-color);
            transform: translateY(-50%) scale(1.1);
        }

        .carousel-arrow.left {
            left: 10px;
        }

        .carousel-arrow.right {
            right: 10px;
        }

        /* Disabled State for Carousel Arrows */
        .carousel-arrow.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Task Status Badge (General) */
        .task-status {
            font-size: 0.8rem;
            font-weight: 500;
            padding: 3px 8px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.15); 
            margin-top: 8px; 
            display: inline-block; 
            align-self: flex-start; 
        }
        /* Task Status Specific Colors/Backgrounds */
        .task-status.status-pending-complition, /* Typo: should be completion? */
        .task-status.status-updates_requested { /* Corrected class name */
            color: var(--due-date-soon);
            background-color: rgba(243, 156, 18, 0.1);
            border: 1px solid rgba(243, 156, 18, 0.3);
        }
        .task-status.status-completed {
            color: var(--due-date-ok);
            background-color: rgba(128, 128, 128, 0.1);
            border: 1px solid rgba(128, 128, 128, 0.3);
        }
        .task-status.status-in_progress { /* Added for consistency */
            color: #3498db; /* Example blue */
            background-color: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        .task-status.status-pending_approval { /* Added for consistency */
             color: #9b59b6; /* Example purple */
             background-color: rgba(155, 89, 182, 0.1);
             border: 1px solid rgba(155, 89, 182, 0.3);
        }


        /* Make Task Cards Clickable */
        .clickable-task-card {
            cursor: pointer;
        }

        /* Task Details Modal Specific Styles */
        #task-details-modal .modal-body p {
            margin-bottom: 12px; 
            line-height: 1.5;
            color: var(--text-secondary);
        }
        #task-details-modal .modal-body p strong {
            color: var(--text-color);
            font-weight: 600;
            margin-right: 5px;
        }
        #modal-task-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--primary-light);
            margin-bottom: 15px;
        }
        #modal-task-description,
        #modal-task-feedback {
            background: rgba(255, 255, 255, 0.03);
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 5px;
            border-left: 3px solid var(--primary-color);
            white-space: pre-wrap; 
            color: var(--text-secondary);
        }
        #modal-task-feedback-container {
            margin-top: 15px;
        }
        #modal-task-status {
            font-size: 0.9rem;
            font-weight: 500;
            padding: 3px 8px;
            border-radius: 5px;
            display: inline-block;
        }
        #task-details-modal .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 15px 30px; 
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(15, 23, 42, 0.9); 
        }

        /* Specific Styling for "Mark as Complete" Button */
        #modal-raise-approval-btn[data-action="complete"] {
            background: linear-gradient(135deg, #66BB6A, #43A047); 
            color: #ffffff; 
            border: none;
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3); 
        }

        #modal-raise-approval-btn[data-action="complete"]:hover {
             background: linear-gradient(135deg, #76C87A, #53B057); 
             box-shadow: 0 10px 25px rgba(76, 175, 80, 0.4);
        }

        /* Task Lookup Modal Styles */
        .task-lookup-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .task-lookup-header {
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .task-lookup-searchbar {
            flex: 1;
            position: relative;
        }

        .task-lookup-searchbar input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 45px 12px 15px;
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .task-lookup-searchbar input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(247, 197, 174, 0.2);
            outline: none;
        }

        .task-lookup-searchbar .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }

        .task-lookup-results {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(247, 197, 174, 0.3) rgba(255, 255, 255, 0.05);
            padding: 10px 0;
        }

        .task-lookup-results::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        .task-lookup-results::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .task-lookup-results::-webkit-scrollbar-thumb {
            background: rgba(247, 197, 174, 0.3);
            border-radius: 10px;
        }

        .task-lookup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            width: 100%;
        }

        .task-result-card {
            background: rgba(30, 40, 60, 0.7);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            transition: all 0.25s ease;
            cursor: pointer;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .task-result-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary-color);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .task-result-title {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 8px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .task-result-desc {
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.5;
            margin-bottom: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            flex: 1;
        }

        .task-result-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            padding-top: 8px;
            margin-top: auto;
        }

        .task-result-status {
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Status Badges within Task Lookup Results */
        .task-result-status.status-completed {
            background: rgba(39, 174, 96, 0.15);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .task-result-status.status-in-progress {
            background: rgba(52, 152, 219, 0.15);
            color: #3498db;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .task-result-status.status-pending,
        .task-result-status.status-updates_requested, /* Added */
        .task-result-status.status-pending_approval { /* Added */
            background: rgba(243, 156, 18, 0.15);
            color: #f39c12;
            border: 1px solid rgba(243, 156, 18, 0.3);
        }

        /* Style for Empty Task Lookup Results */
        .task-lookup-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
            color: var(--text-secondary);
            text-align: center;
        }

        .task-lookup-empty i {
            font-size: 3rem;
            color: rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
        }

        /* Style for Loading State in Task Lookup */
        .task-lookup-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 0;
        }

        .task-lookup-loading i {
            font-size: 1.5rem;
            color: var(--primary-color);
            animation: spin 1.5s linear infinite;
        }

        /* Task Details Modal: Column Layout */
        .task-details-columns {
            display: flex;
            gap: 30px;
            height: 100%;
        }

        .task-details-column {
            flex: 1;
            max-width: 55%;
            overflow: hidden;
        }

        .task-history-column {
            flex: 1;
            max-width: 45%;
            padding-left: 30px;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(247, 197, 174, 0.3) rgba(255, 255, 255, 0.05);
        }

        .task-history-column::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        .task-history-column::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .task-history-column::-webkit-scrollbar-thumb {
            background: rgba(247, 197, 174, 0.3);
            border-radius: 10px;
        }

        /* Section Title Styling (e.g., "Task Information", "Task History") */
        .section-title {
            font-size: 1.05rem;
            font-weight: 600;
            
            color: var(--primary-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Card Containing Task Information Details */
        .task-info-card {
            background: rgba(30, 40, 60, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 15px;
            margin-bottom: 20px;
        }

        /* Header within the Task Info Card */
        .task-info-header {
            margin-bottom: 15px;
        }

        .task-info-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 5px; 
        }

        .task-info-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px; 
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.2); 
            margin-top: 0; 
        }

        /* Individual Detail Row (Label + Value) */
        .task-info-detail {
            margin-bottom: 10px;
            display: flex;
            gap: 8px;
        }

        .task-info-label {
            color: var(--primary-light);
            font-weight: 500;
            font-size: 0.9rem;
            flex-shrink: 0;
            min-width: 100px;
        }

        .task-info-value {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Task Description Box */
        .task-info-description {
            background: rgba(20, 30, 50, 0.5);
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            border-left: 2px solid var(--primary-color);
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        /* Task History Timeline */
        .task-timeline {
            position: relative;
            padding-left: 25px;
        }

        .timeline-track {
            position: absolute;
            left: 9px;
            top: 15px;
            bottom: 15px;
            width: 2px;
            background-color: var(--timeline-line);
            z-index: 1;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 25px;
            padding-bottom: 5px;
        }

        .timeline-item:last-child {
            margin-bottom: 0;
        }

        .timeline-dot {
            position: absolute;
            left: -25px;
            top: 2px;
            width: 18px;
            height: 18px;
            background-color: var(--timeline-dot);
            border: 3px solid var(--timeline-dot-border);
            border-radius: 50%;
            z-index: 2;
        }

        .timeline-content {
            position: relative;
            padding: 12px 15px;
            background: var(--timeline-card);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Arrow Pointer for Timeline Content Box */
        .timeline-content::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 12px;
            width: 12px;
            height: 12px;
            background: var(--timeline-card);
            transform: rotate(45deg);
            border-left: 1px solid rgba(255, 255, 255, 0.08);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .timeline-status {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .timeline-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .timeline-feedback {
            font-size: 0.85rem;
            color: var(--text-secondary);
            background: rgba(20, 30, 50, 0.5);
            border-radius: 6px;
            padding: 8px 10px;
            margin-top: 8px;
            border-left: 2px solid var(--primary-color);
        }

        /* Wrapper for Section Title and Status Badge */
        .section-header-wrapper {
            display: flex;
            align-items: center;
            margin-bottom: 15px; 
        }

        /* Task Lookup Modal Specific Container Size */
        #task-lookup-modal .modal-container {
            max-width: 85%;
            width: 85%;
            height: 80%;
            max-height: 80%;
        }

        #task-lookup-modal .modal-body {
            padding: 20px;
            height: calc(100% - 70px); 
            overflow: hidden;
        }

        /* Responsive Adjustments for Task Lookup Modal */
        @media (max-width: 992px) {
            #task-lookup-modal .modal-container {
                width: 95%;
                max-width: 95%;
                height: 90%;
                max-height: 90%;
            }

            .task-lookup-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .task-lookup-grid {
                grid-template-columns: 1fr;
            }

            /* Stack Task Details Columns on Small Screens */
            .task-details-columns {
                flex-direction: column;
                gap: 20px;
            }

            .task-details-column,
            .task-history-column {
                max-width: 100%;
                width: 100%;
            }

            .task-history-column {
                padding-left: 0;
                border-left: none;
                padding-top: 20px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }

            /* Hide Status Badge in Task Lookup Details */
            .task-info-status.hide-for-lookup {
            display: none !important; 
            }

            /* Hide History Column when viewing Pending Task Details */
            #task-details-modal.modal-context-pending .task-history-column {
    display: none !important; 
            }
            #task-details-modal.modal-context-pending .task-details-column {
            max-width: 100%;
            width: 100%;
            padding-right: 0; 
            border-right: none; 
            }
        }

        /* Utility class to hide elements specifically in lookup context */
        .hidden-in-lookup {
           display: none !important;
        }
/* Dynamic Search Results Styling */
/* Stacking context for dynamic search form group */
        .form-group-dynamic-search {
            position: relative; /* Establish stacking context */
            z-index: 5; /* Lift above subsequent form groups (adjust if needed) */
        }
        .dynamic-search-wrapper {
            position: relative; /* Needed for absolute positioning of results */
        }

        .dynamic-results-container {
            position: absolute;
            top: 100%; /* Position below the input */
            left: 0;
            right: 0;
            background: rgba(30, 40, 60, 0.98); /* Slightly darker than modal body */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-top: none; /* Avoid double border with input */
            border-radius: 0 0 12px 12px; /* Match input bottom radius */
            max-height: 200px; /* Limit height and enable scrolling */
            overflow-y: auto;
            z-index: 1000; /* Further increased z-index */
            display: none; /* Hidden by default */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            /* Custom Scrollbar */
            scrollbar-width: thin;
            scrollbar-color: rgba(247, 197, 174, 0.3) rgba(255, 255, 255, 0.05);
        }

        .dynamic-results-container::-webkit-scrollbar { width: 5px; }
        .dynamic-results-container::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 10px; }
        .dynamic-results-container::-webkit-scrollbar-thumb { background: rgba(247, 197, 174, 0.3); border-radius: 10px; }

        .dynamic-result-item {
            padding: 10px 15px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05); /* Separator line */
            font-size: 0.9rem;
        }
        .dynamic-result-item:last-child {
            border-bottom: none; /* No border for the last item */
        }

        .dynamic-result-item:hover,
        .dynamic-result-item.highlighted { /* Class for keyboard navigation */
            background-color: rgba(247, 197, 174, 0.1);
            color: var(--primary-light);
        }

        .dynamic-results-container.visible {
            display: block; /* Show when populated */
        }

        .dynamic-results-container .loading-item,
        .dynamic-results-container .no-results-item {
            padding: 10px 15px;
            color: var(--text-secondary);
            font-style: italic;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Background Elements -->
    <div class="background-wrapper">
        <div class="moving-bg"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <!-- Logo -->
        <a href="/home" class="logo">
            <i class="fas fa-chart-line"></i>
            <span>ILNB-Dashboard</span>
        </a>

        <!-- User Information & Actions -->
        <div class="user-info">
            <!-- Hidden User Data -->
            <input type="hidden" id="user-id" value="{{ id if id else '' }}">
            <input type="hidden" id="user-name" value="{{ username }}">

            <!-- User Profile Display -->
            <div class="user-profile">
                <div class="avatar">
                    {{ username[0]|upper }}
                </div>
                <div class="user-details"> <!-- Hidden on small screens -->
                    <div class="username">{{ username }}</div>
                </div>
            </div>

            <!-- Header Actions -->
            <div class="actions">
                <a href="/logout" class="action-btn logout-btn" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </div>
    </header>

    <!-- Pending Tasks Section -->
    <section class="tasks-section" id="tasks-section">
        <!-- Tasks Section Header -->
        <div class="tasks-header">
            <h2>Pending Tasks</h2>
            <div class="tasks-header-actions">
                <button class="refresh-tasks-btn" id="refresh-tasks-btn" title="Refresh Tasks">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="expand-tasks-btn hidden" id="expand-tasks-btn"> <!-- Initially hidden, shown if >4 tasks -->
                    <span>Expand</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
        </div>
        <!-- Task Cards Carousel -->
        <div class="tasks-carousel-wrapper">
             <button class="carousel-arrow left disabled" id="task-arrow-left"><i class="fas fa-chevron-left"></i></button>
             <div id="tasks-list-container">
                 <!-- Task cards are loaded here by JavaScript -->
                 <p id="loading-tasks-message" style="text-align: center; padding: 20px; color: var(--text-secondary); width: 100%;">Loading tasks...</p>
             </div>
             <button class="carousel-arrow right" id="task-arrow-right"><i class="fas fa-chevron-right"></i></button>
        </div>
    </section>

    <!-- Main Content Area (Action Cards) -->
    <main class="main-container">
        <!-- Action Cards Grid -->
        <div class="cards-grid">
            <!-- Add Client Card -->
            <div class="card" id="add-client-card">
                <div class="card-content">
                    <div class="card-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <h3 class="card-title">Add Client</h3>
                    <p class="card-description">Add a new client to your database with all required information.</p>
                    <div class="card-action">
                        <span>Add New</span>
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
            </div>

            <!-- Add Lead Card -->
            <div class="card" id="add-lead-card">
                <div class="card-content">
                    <div class="card-icon">
                        <i class="fas fa-user-tag"></i>
                    </div>
                    <h3 class="card-title">Add Lead</h3>
                    <p class="card-description">Add a new lead to the database with relevant details.</p>
                    <div class="card-action">
                        <span>Add New</span>
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
            </div>

            <!-- Add Product Card -->
            <div class="card" id="add-product-card">
                <div class="card-content">
                    <div class="card-icon">
                        <i class="fas fa-box-open"></i>
                    </div>
                    <h3 class="card-title">Add Product</h3>
                    <p class="card-description">Add a new product to the inventory database.</p>
                    <div class="card-action">
                        <span>Add New</span>
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
            </div>

            <!-- Add User Card -->
            <div class="card" id="add-users-card">
                <div class="card-content">
                    <div class="card-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <h3 class="card-title">Add User</h3>
                    <p class="card-description">Add a new user account with appropriate roles and teams.</p>
                    <div class="card-action">
                        <span>Add New</span>
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
            </div>

            <!-- Assign Task Card -->
            <div class="card" id="assign-task-card">
                <div class="card-content">
                    <div class="card-icon">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <h3 class="card-title">Assign Task</h3>
                    <p class="card-description">Assign a new task to a user with a title, description, and due date.</p>
                    <div class="card-action">
                        <span>Assign New</span>
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
            </div>

            <!-- Task Lookup Card -->
            <div class="card" id="task-lookup-card">
                <div class="card-content">
                    <div class="card-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3 class="card-title">Task Look Up</h3>
                    <p class="card-description">Search and view task details using advanced filters and criteria.</p>
                    <div class="card-action">
                        <span>Search Tasks</span>
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
            </div>
        </div> <!-- End .cards-grid -->

        <!-- Modals -->
        <!-- Add Client Modal -->
        <div class="modal" id="add-client-modal">
            <div class="modal-backdrop"></div>
            <div class="modal-container">
                <div class="modal-header">
                    <h3>Add New Client</h3>
                </div>
                <div class="modal-body">
                    <form id="add-client-form" action="/add-client" method="POST">
                        <!-- Full Name -->
                        <div class="form-group"> <!-- Changed from form-row as it's a single full-width field -->
                            <label for="client-name">Full Name <span class="required">*</span></label>
                            <div class="input-wrapper">
                                <input type="text" id="client-name" name="name" class="form-control" required>
                                <i class="input-icon fas fa-user"></i>
                            </div>
                            <div class="error-message"></div>
                        </div>

                        <!-- Email & Mobile -->
                        <div class="form-row">
                            <div class="form-group half">
                                <label for="client-email">Email <span class="required">*</span></label>
                                <div class="input-wrapper">
                                    <input type="email" id="client-email" name="emailid" class="form-control" required>
                                    <i class="input-icon fas fa-envelope"></i>
                                </div>
                                <div class="error-message"></div>
                            </div>
                            <div class="form-group half">
                                <label for="client-mobile">Mobile <span class="required">*</span></label>
                                <div class="input-wrapper">
                                    <input type="tel" id="client-mobile" name="mobile" class="form-control" required>
                                    <i class="input-icon fas fa-phone"></i>
                                </div>
                                <div class="error-message"></div>
                            </div>
                        </div>

                        <!-- PAN & DOB -->
                        <div class="form-row">
                            <div class="form-group half">
                                <label for="client-pan">PAN <span class="required">*</span></label>
                                <div class="input-wrapper">
                                    <input type="text" id="client-pan" name="pan" class="form-control" required>
                                    <i class="input-icon fas fa-id-card"></i>
                                </div>
                                <div class="error-message"></div>
                            </div>
                            <div class="form-group half">
                                <label for="client-dob">Date of Birth</label>
                                <div class="input-wrapper">
                                    <input type="date" id="client-dob" name="dob" class="form-control">
                                    <i class="input-icon fas fa-calendar clickable"></i>
                                </div>
                                <div class="error-message"></div>
                            </div>
                        </div>

                        <!-- Address -->
                        <div class="form-group">
                            <label for="client-address">Address</label>
                            <div class="input-wrapper">
                                <textarea id="client-address" name="address" class="form-control" rows="3"></textarea>
                                <i class="input-icon fas fa-home" style="top: 15px;"></i>
                            </div>
                            <div class="error-message"></div>
                        </div>

                        <!-- Active Products & Assigned RM -->
                        <div class="form-row">
                            <div class="form-group half">
                                <label for="client-products">Active Products</label>
                                <div class="input-wrapper">
                                    <input type="text" id="client-products" name="activeproducts" class="form-control" placeholder="Comma separated list">
                                    <i class="input-icon fas fa-tags"></i>
                                </div>
                                <div class="error-message"></div>
                            </div>
                            <div class="form-group half">
                                <label for="client-rm">Assigned RM</label>
                                <div class="input-wrapper">
                                    <input type="text" id="client-rm" name="assignedrm" class="form-control">
                                    <i class="input-icon fas fa-user-tie"></i>
                                </div>
                                <div class="error-message"></div>
                            </div>
                        </div>

                        <!-- Lead ID -->
                        <div class="form-group">
                            <label for="client-leadid">Lead ID</label>
                            <div class="input-wrapper">
                                <input type="number" id="client-leadid" name="leadid" class="form-control">
                                <i class="input-icon fas fa-hashtag"></i>
                            </div>
                             <div class="error-message"></div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <button type="button" class="btn-secondary cancel-modal">Cancel</button>
                            <button type="submit" class="btn-primary">
                                <span>Add Client</span>
                                <div class="loading-spinner"></div> <!-- Spinner for loading state -->
                            </button>
                        </div>
                    </form>
                </div> <!-- End .modal-body -->
            </div> <!-- End .modal-container -->
        </div> <!-- End #add-client-modal -->

        <!-- Add Lead Modal -->
        <div class="modal" id="add-lead-modal">
            <div class="modal-backdrop"></div>
            <div class="modal-container">
                <div class="modal-header">
                    <h3>Add New Lead</h3>
                </div>
                <div class="modal-body">
                    <form id="add-lead-form" action="/add-lead" method="POST">
                        <!-- Lead Name -->
                        <div class="form-group">
                            <label for="lead-name">Lead Name <span class="required">*</span></label>
                            <div class="input-wrapper">
                                <input type="text" id="lead-name" name="leadname" class="form-control" required>
                                <i class="input-icon fas fa-user"></i>
                            </div>
                            <div class="error-message"></div>
                        </div>

                        <!-- Lead Generator Dropdown -->
                         <!-- Lead Generator Dynamic Search Input -->
                         <div class="form-group form-group-dynamic-search"> <!-- Added class -->
                            <label for="lead-generator-search">Lead Generator <span class="required">*</span></label>
                            <div class="input-wrapper dynamic-search-wrapper">
                                <input type="text" id="lead-generator-search" name="leadgenerator_search" class="form-control" placeholder="Type to search users..." required autocomplete="off">
                                <i class="input-icon fas fa-search"></i>
                                <div class="dynamic-results-container" id="lead-generator-results">
                                    <!-- Search results will be populated here by JS -->
                                </div>
                            </div>
                            <div class="error-message"></div> <!-- Error message for the input field -->
                        </div>
                        <!-- Hidden input to store selected user data as JSON string -->
                        <input type="hidden" id="lead-generator-data" name="leadgenerator" required> <!-- Keep this hidden input, make it required -->

                        <!-- Lead Converter Dropdown Removed -->
                        <!-- Hidden inputs to store selected user data as JSON string -->
                        <input type="hidden" id="lead-generator-data" name="leadgenerator">
                        <input type="hidden" id="lead-converter-data" name="leadconverter">

                        <!-- Feedback (Optional) -->
                        <div class="form-group">
                            <label for="lead-feedback">Feedback</label>
                            <div class="input-wrapper">
                                <textarea id="lead-feedback" name="leadfeedback" class="form-control" rows="2"></textarea>
                                <i class="input-icon fas fa-comment-dots" style="top: 15px;"></i>
                            </div>
                            <div class="error-message"></div>
                        </div>

                        <!-- Mode of Communication -->
                        <div class="form-group">
                            <label for="lead-moc">Mode of Communication <span class="required">*</span></label>
                            <div class="input-wrapper">
                                <select id="lead-moc" name="leadMOC" class="form-control" required>
                                    <option value="" disabled selected>Select Mode</option>
                                    <option value="call">Call</option>
                                    <option value="mail">Mail</option>
                                    <option value="whatsapp">WhatsApp</option>
                                    <option value="Face to Face">Face to Face</option>
                                </select>
                                <i class="input-icon fas fa-chevron-down select-arrow"></i>
                            </div>
                            <div class="error-message"></div>
                        </div>

                        <!-- Lead Status Dropdown -->
                        <div class="form-group">
                            <label for="lead-status">Lead Status <span class="required">*</span></label>
                            <div class="input-wrapper">
                                <select id="lead-status" name="leadstatus" class="form-control" required>
                                    <option value="" disabled selected>Select Status</option>
                                    <option value="Successful">Successful</option>
                                    <option value="Failed">Failed</option>
                                    <option value="In Progress">In Progress</option>
                                </select>
                                <i class="input-icon fas fa-chevron-down select-arrow"></i>
                            </div>
                            <div class="error-message"></div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <button type="button" class="btn-secondary cancel-modal">Cancel</button>
                            <button type="submit" class="btn-primary">
                                <span>Add Lead</span>
                                <div class="loading-spinner"></div>
                            </button>
                        </div>
                    </form>
                </div> <!-- End .modal-body -->
            </div> <!-- End .modal-container -->
        </div> <!-- End #add-lead-modal -->

        <!-- Add Product Modal -->
        <div class="modal" id="add-product-modal">
            <div class="modal-backdrop"></div>
            <div class="modal-container">
                <div class="modal-header">
                    <h3>Add New Product</h3>
                </div>
                <div class="modal-body">
                    <form id="add-product-form" action="/add-product" method="POST">
                        <!-- Product ID -->
                        <div class="form-group">
                            <label for="product-id">Product ID <span class="required">*</span></label>
                            <div class="input-wrapper">
                                <input type="text" id="product-id" name="productid" class="form-control" required>
                                <i class="input-icon fas fa-barcode"></i>
                            </div>
                            <div class="error-message"></div>
                        </div>

                        <!-- Product Name -->
                        <div class="form-group">
                            <label for="product-name">Product Name <span class="required">*</span></label>
                            <div class="input-wrapper">
                                <input type="text" id="product-name" name="productname" class="form-control" required>
                                <i class="input-icon fas fa-tag"></i>
                            </div>
                            <div class="error-message"></div>
                        </div>

                        <!-- Product Description -->
                        <div class="form-group">
                            <label for="product-description">Product Description</label>
                            <div class="input-wrapper">
                                <textarea id="product-description" name="product_description" class="form-control" rows="3"></textarea>
                                <i class="input-icon fas fa-align-left" style="top: 15px;"></i>
                            </div>
                            <div class="error-message"></div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <button type="button" class="btn-secondary cancel-modal">Cancel</button>
                            <button type="submit" class="btn-primary">
                                <span>Add Product</span>
                                <div class="loading-spinner"></div>
                            </button>
                        </div>
                    </form>
                </div> <!-- End .modal-body -->
            </div> <!-- End .modal-container -->
        </div> <!-- End #add-product-modal -->

        <!-- Add User Modal -->
        <div class="modal" id="add-user-modal">
            <div class="modal-backdrop"></div>
            <div class="modal-container">
                <div class="modal-header">
                    <h3>Add New User</h3>
                </div>
                <div class="modal-body">
                    <form id="add-user-form"> <!-- Note: No action/method, handled by JS -->
                        <!-- Username -->
                        <div class="form-group">
                            <label for="user-username">Username <span class="required">*</span></label>
                            <div class="input-wrapper">
                                <input type="text" id="user-username" name="username" class="form-control" required>
                                <i class="input-icon fas fa-user"></i>
                            </div>
                            <div class="error-message"></div>
                        </div>

                        <!-- Email -->
                        <div class="form-group">
                            <label for="user-email">Email <span class="required">*</span></label>
                            <div class="input-wrapper">
                                <input type="email" id="user-email" name="emailid" class="form-control" required>
                                <i class="input-icon fas fa-envelope"></i>
                            </div>
                            <div class="error-message"></div>
                        </div>

                        <!-- Password -->
                        <div class="form-group">
                            <label for="user-password">Password <span class="required">*</span></label>
                            <div class="input-wrapper">
                                <input type="password" id="user-password" name="password" class="form-control" required>
                                <i class="input-icon fas fa-lock"></i>
                            </div>
                            <div class="error-message"></div>
                        </div>

                        <!-- Role & Team -->
                        <div class="form-row">
                            <div class="form-group half">
                                <label for="user-role">Role <span class="required">*</span></label>
                                <div class="input-wrapper">
                                    <select id="user-role" name="roleid" class="form-control" required>
                                        <option value="" disabled selected>Select Role</option>
                                        <!-- Options populated by JS -->
                                    </select>
                                    <i class="input-icon fas fa-chevron-down select-arrow"></i>
                                </div>
                                <div class="error-message"></div>
                            </div>
                            <div class="form-group half">
                                <label for="user-team">Team <span class="required">*</span></label>
                                <div class="input-wrapper">
                                    <select id="user-team" name="teamid" class="form-control" required>
                                        <option value="" disabled selected>Select Team</option>
                                        <!-- Options populated by JS -->
                                    </select>
                                    <i class="input-icon fas fa-chevron-down select-arrow"></i>
                                </div>
                                <div class="error-message"></div>
                            </div>
                        </div>

                        <!-- Mobile -->
                        <div class="form-group">
                            <label for="user-mobile">Mobile <span class="required">*</span></label>
                            <div class="input-wrapper">
                                <input type="tel" id="user-mobile" name="mobile" class="form-control" required>
                                <i class="input-icon fas fa-phone"></i>
                            </div>
                            <div class="error-message"></div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <button type="button" class="btn-secondary cancel-modal">Cancel</button>
                            <button type="submit" class="btn-primary">
                                <span>Add User</span>
                                <div class="loading-spinner"></div>
                            </button>
                        </div>
                    </form>
                </div> <!-- End .modal-body -->
            </div> <!-- End .modal-container -->
        </div> <!-- End #add-user-modal -->

    </main> <!-- End .main-container -->

    <!-- Task Lookup Modal -->
    <div class="modal" id="task-lookup-modal">
        <div class="modal-backdrop"></div>
        <div class="modal-container" style="max-width: 65rem; top: 51%;"> <!-- Wider modal -->
            <div class="modal-header">
                <h3>Task Look Up</h3>
            </div>
            <div class="modal-body">
                <div class="task-lookup-container">
                    <!-- Search Header -->
                    <div class="task-lookup-header">
                        <div class="task-lookup-searchbar">
                            <input type="text" id="task-search" placeholder="Search tasks by title, description or status...">
                            <i class="search-icon fas fa-search"></i>
                        </div>
                    </div>
                    <!-- Search Results Area -->
                    <div class="task-lookup-results" id="search-results">
                        <!-- Loading state shown initially -->
                        <div class="task-lookup-loading">
                            <i class="fas fa-spinner"></i>
                        </div>
                        <!-- Results populated by JS -->
                    </div>
                    <!-- Modal Actions -->
                    <div class="form-actions">
                        <button type="button" class="btn-secondary cancel-modal">Close</button>
                    </div>
                </div> <!-- End .task-lookup-container -->
            </div> <!-- End .modal-body -->
        </div> <!-- End .modal-container -->
    </div> <!-- End #task-lookup-modal -->

    <!-- Task Details Modal -->
    <div class="modal" id="task-details-modal">
        <div class="modal-backdrop"></div>
        <div class="modal-container" style="max-width: 65rem;"> <!-- Wider modal -->
            <div class="modal-header">
                <h3>Task Details</h3>
            </div>
            <div class="modal-body">
                <div class="task-details-columns">
                    <!-- Task Information Column -->
                    <div class="task-details-column">
                        <div class="section-header-wrapper">
                            <h4 class="section-title"><i class="fas fa-info-circle"></i> Task Information</h4>
                            <span class="task-info-status" id="modal-task-status" style="margin-left: 10px;">Loading...</span>
                        </div>
                        <div class="task-info-card">
                            <div class="task-info-header">
                                <div class="task-info-title" id="modal-task-title">Loading task...</div>
                                <!-- Status is now in section-header-wrapper -->
                            </div>

                            <!-- Task Details -->
                            <div class="task-info-detail">
                                <div class="task-info-label">Assigned By:</div>
                                <div class="task-info-value" id="modal-task-assigned-by">Loading...</div>
                            </div>
                            <div class="task-info-detail">
                                <div class="task-info-label">Assigned To:</div>
                                <div class="task-info-value" id="modal-task-assigned-to">Loading...</div>
                            </div>
                            <div class="task-info-detail">
                               <div class="task-info-label">Start Date:</div>
                               <div class="task-info-value" id="modal-task-start-date">Loading...</div>
                            </div>
                            <div class="task-info-detail">
                               <div class="task-info-label">Due Date:</div>
                               <div class="task-info-value" id="modal-task-due-date">Loading...</div>
                            </div>

                            <!-- Description -->
                            <div class="task-info-detail"> <!-- Wrap description label -->
                                <div class="task-info-label">Description:</div>
                            </div>
                            <div class="task-info-description" id="modal-task-description">Loading task description...</div>

                            <!-- Feedback Section (Shown conditionally by JS) -->
                            <div id="modal-task-feedback-container" style="display: none; margin-top: 15px;">
                                <div class="task-info-label">Feedback:</div>
                                <div class="task-info-description" id="modal-task-feedback" style="border-left-color: var(--due-date-soon);"></div>
                            </div>
                        </div> <!-- End .task-info-card -->
                    </div> <!-- End .task-details-column -->

                    <!-- Task History Column (Hidden if no history or in pending context) -->
                    <div class="task-history-column" style="padding-right: 30px; max-height: 36.5rem;">
                        <h4 class="section-title"><i class="fas fa-history"></i> Task History</h4>
                        <div class="task-timeline" id="task-timeline">
                            <div class="timeline-track"></div>
                            <!-- Loading state / Timeline items populated by JS -->
                            <div class="timeline-item">
                                <div class="timeline-dot"></div>
                                <div class="timeline-content">
                                    <div class="timeline-status">Loading history...</div>
                                </div>
                            </div>
                        </div> <!-- End .task-timeline -->
                    </div> <!-- End .task-history-column -->
                </div> <!-- End .task-details-columns -->
            </div> <!-- End .modal-body -->
            <div class="modal-footer">
                <button type="button" class="btn-secondary cancel-modal">Close</button>
                <!-- Request Changes Button (Shown conditionally by JS) -->
                <button type="button" id="modal-request-changes-btn" class="btn-secondary" style="display: none; background-color: rgba(243, 156, 18, 0.15); border-color: rgba(243, 156, 18, 0.4); color: #f39c12;">
                    <span>Request Changes</span>
                </button>
                <!-- Raise Approval / Mark Complete Button (Shown conditionally by JS) -->
                <button type="button" id="modal-raise-approval-btn" class="btn-primary" style="display: none;">
                    <span>Raise for Approval</span> <!-- Text changes based on context -->
                </button>
            </div> <!-- End .modal-footer -->
        </div> <!-- End .modal-container -->
    </div> <!-- End #task-details-modal -->

    <!-- Feedback Modal -->
    <div class="modal" id="feedback-modal">
        <div class="modal-backdrop"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h3>Request Changes Feedback</h3>
            </div>
            <div class="modal-body">
                <form id="feedback-form">
                    <input type="hidden" id="feedback-task-id"> <!-- Populated by JS -->
                    <!-- New Due Date (Optional) -->
                    <div class="form-group">
                        <label for="feedback-due-date">New Due Date (Optional):</label>
                        <div class="input-wrapper">
                            <input type="date" id="feedback-due-date" name="new_due_date" class="form-control">
                            <i class="input-icon fas fa-calendar-alt clickable"></i> <!-- Made clickable -->
                        </div>
                        <!-- No error message needed as it's optional -->
                    </div>
                    <!-- Feedback Text -->
                    <div class="form-group">
                        <label for="feedback-text">Please provide feedback for the requested changes:<span class="required">*</span></label>
                        <div class="input-wrapper">
                            <textarea id="feedback-text" name="feedback" class="form-control" rows="4" required></textarea>
                            <i class="input-icon fas fa-comment-dots" style="top: 15px;"></i>
                        </div>
                        <div class="error-message"></div>
                    </div>
                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="button" class="btn-secondary cancel-modal">Cancel</button>
                        <button type="submit" class="btn-primary">
                            <span>Submit Feedback</span>
                            <div class="loading-spinner"></div>
                        </button>
                    </div>
                </form>
            </div> <!-- End .modal-body -->
        </div> <!-- End .modal-container -->
    </div> <!-- End #feedback-modal -->

    <!-- Assign Task Modal -->
    <div class="modal" id="assign-task-modal">
        <div class="modal-backdrop"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h3>Assign New Task</h3>
            </div>
            <div class="modal-body">
                <form id="assign-task-form"> <!-- Note: No action/method, handled by JS -->
                    <!-- Task Title -->
                    <div class="form-group">
                        <label for="task-title">Task Title <span class="required">*</span></label>
                        <div class="input-wrapper">
                            <input type="text" id="task-title" name="task_title" class="form-control" required>
                            <i class="input-icon fas fa-heading"></i>
                        </div>
                        <div class="error-message"></div>
                    </div>

                    <!-- Task Description -->
                    <div class="form-group">
                        <label for="task-description">Task Description <span class="required">*</span></label>
                        <div class="input-wrapper">
                            <textarea id="task-description" name="task_description" class="form-control" rows="3" required></textarea>
                            <i class="input-icon fas fa-align-left" style="top: 15px;"></i>
                        </div>
                        <div class="error-message"></div>
                    </div>

                    <!-- Due Date & Assignee -->
                    <div class="form-row">
                        <div class="form-group half">
                            <label for="task-due-date">Due Date <span class="required">*</span></label>
                            <div class="input-wrapper">
                                <input type="date" id="task-due-date" name="due_date" class="form-control" required>
                                <i class="input-icon fas fa-calendar clickable"></i>
                            </div>
                            <div class="error-message"></div>
                        </div>
                        <div class="form-group half">
                            <label for="task-assignee">Assign To <span class="required">*</span></label>
                            <div class="input-wrapper">
                                <select id="task-assignee" name="assignee" class="form-control" required>
                                    <option value="" disabled selected>Select User</option>
                                    <!-- Options populated by JS -->
                                </select>
                                <i class="input-icon fas fa-chevron-down select-arrow"></i>
                            </div>
                            <div class="error-message"></div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="button" class="btn-secondary cancel-modal">Cancel</button>
                        <button type="submit" class="btn-primary">
                            <span>Assign Task</span>
                            <div class="loading-spinner"></div>
                        </button>
                    </div>
                </form>
            </div> <!-- End .modal-body -->
        </div> <!-- End .modal-container -->
    </div> <!-- End #assign-task-modal -->

<script>
    // --- Task Lookup Functionality ---
    let searchDebounceTimer; // Timer for debouncing search input

    /**
     * Initializes the task lookup modal interactions, search input, and results display.
     */
    function initializeTaskLookup() {
        console.log('Initializing task lookup...');
        const searchInput = document.getElementById('task-search');
        const searchResults = document.getElementById('search-results');
        // const lookupCard = document.getElementById('task-lookup-card'); // Not directly used here
        const lookupModal = document.getElementById('task-lookup-modal');

        if (!searchInput || !searchResults || !lookupModal) {
            console.error("Task lookup modal elements (input, results, or modal itself) not found.");
            return;
        }

        // Observer to fetch initial tasks when the modal becomes active
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class' && mutation.target.classList.contains('active')) {
                    console.log('Task lookup modal opened, fetching initial tasks...');
                    fetchTaskResults('', searchResults); // Fetch all tasks initially
                }
            });
        });

        observer.observe(lookupModal, {
            attributes: true,
            attributeFilter: ['class']
        });

        // Event listener for search input with debouncing
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchDebounceTimer);
            const searchString = e.target.value.trim();
            searchDebounceTimer = setTimeout(() => {
                console.log(`Debounced search triggered for: "${searchString}"`);
                fetchTaskResults(searchString, searchResults);
            }, 300); // 300ms delay
        });

        // Event listener for clicking on a task result card
        searchResults.addEventListener('click', (e) => {
            const taskCard = e.target.closest('.task-result-card');
            if (taskCard) {
                const taskId = taskCard.dataset.taskId;
                if (taskId) {
                    console.log(`Task result card clicked, fetching details for task ID: ${taskId}`);
                    fetchTaskDetails(taskId);
                } else {
                    console.warn("Clicked task result card missing task ID.");
                }
            }
        });
    }

    /**
     * Fetches task results based on a search string and updates the results container.
     * @param {string} searchString - The search query.
     * @param {HTMLElement} resultsContainer - The container element to display results in.
     */
    function fetchTaskResults(searchString, resultsContainer) {
        console.log(`Fetching task results for search: "${searchString}"`);
        // Show loading state
        resultsContainer.innerHTML = `
            <div class="task-lookup-loading">
                <i class="fas fa-spinner fa-spin"></i> <!-- Added fa-spin -->
            </div>`;

        fetch('/task_lookup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ search_string: searchString })
        })
        .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err)))
        .then(data => {
            if (data.success) {
                console.log("Successfully fetched task results:", data.data);
                displaySearchResults(data.data, resultsContainer);
            } else {
                throw new Error(data.message || 'Failed to fetch results');
            }
        })
        .catch(error => {
            console.error('Error fetching task results:', error);
            resultsContainer.innerHTML = `
                <div class="task-lookup-empty">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>Error fetching results: ${escapeHtml(error.message)}</p>
                </div>`;
            showNotification(`Error fetching task results: ${error.message}`, 'error');
        });
    }

    /**
     * Fetches detailed information for a specific task ID.
     * @param {string} taskId - The ID of the task to fetch.
     */
    function fetchTaskDetails(taskId) {
        console.log(`Fetching details for task ID: ${taskId}`);
        // Consider adding a loading indicator specific to the details modal if needed
        fetch('/task_lookup', { // Uses the same endpoint, but specifies task_id
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: taskId })
        })
        .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err)))
        .then(data => {
            if (data.success && data.data) {
                console.log("Successfully fetched task details:", data.data);
                showTaskDetailsPopup(data.data, 'lookup'); // Show details in the popup
            } else {
                throw new Error(data.message || 'Failed to fetch task details');
            }
        })
        .catch(error => {
            console.error('Error fetching task details:', error);
            showNotification(`Error fetching task details: ${error.message}`, 'error');
        });
    }

    /**
     * Displays the fetched task search results in the specified container.
     * @param {Array} tasks - An array of task objects.
     * @param {HTMLElement} container - The container element to display results in.
     */
    function displaySearchResults(tasks, container) {
        if (!tasks || tasks.length === 0) {
            container.innerHTML = `
                <div class="task-lookup-empty">
                    <i class="fas fa-search"></i>
                    <p>No tasks found matching your search.</p>
                </div>`;
            return;
        }

        const gridContainer = document.createElement('div');
        gridContainer.className = 'task-lookup-grid';

        tasks.forEach(task => {
            const statusClass = getStatusClass(task.status); // Get CSS class for status
            const card = document.createElement('div');
            card.className = 'task-result-card';
            card.dataset.taskId = task.task_id; // Store task ID for click handling

            // const formattedDate = task.due_date ? formatDate(task.due_date) : 'No date'; // Not used in current card HTML

            card.innerHTML = `
                <div class="task-result-title">${escapeHtml(task.task_title || 'Untitled Task')}</div>
                <div class="task-result-desc">${escapeHtml(task.task_description || 'No description provided.')}</div>
                <div class="task-result-meta">
                     <span class="task-result-status ${statusClass}">${escapeHtml(task.status || 'Unknown')}</span>
                     <span>ID: ${escapeHtml(task.task_id.substring(0, 8))}...</span> <!-- Show partial ID -->
                </div>
            `;
            gridContainer.appendChild(card);
        });

        container.innerHTML = ''; // Clear previous results/loading
        container.appendChild(gridContainer);
        console.log(`Displayed ${tasks.length} search results.`);
    }

    /**
     * Determines the appropriate CSS class based on the task status string.
     * @param {string} status - The task status string.
     * @returns {string} The corresponding CSS class name.
     */
    function getStatusClass(status) {
        if (!status) return '';
        const statusLower = status.toLowerCase().replace(/\s+/g, '_'); // Normalize status string
        // Map normalized status to CSS classes
        const statusMap = {
            'completed': 'status-completed',
            'in_progress': 'status-in-progress',
            'pending_approval': 'status-pending', // Example mapping
            'updates_requested': 'status-pending', // Example mapping
            'pending': 'status-pending' // Generic pending
        };
        return statusMap[statusLower] || ''; // Return mapped class or empty string
    }

    /**
     * Formats a date string into a more readable format (e.g., "Apr 28, 2025").
     * @param {string} dateString - The date string to format.
     * @returns {string} The formatted date string or 'N/A'.
     */
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            // Check if date is valid after parsing
            if (isNaN(date.getTime())) {
                throw new Error("Invalid date value");
            }
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (e) {
            console.error(`Error formatting date "${dateString}":`, e);
            return 'Invalid Date'; // Return a clear indicator of error
        }
    }

    /**
     * Formats a date-time string into a more readable format (e.g., "Apr 28, 2025, 02:09 AM").
     * @param {string} dateTimeString - The date-time string to format.
     * @returns {string} The formatted date-time string or 'Date unknown'.
     */
    function formatDateTime(dateTimeString) {
        if (!dateTimeString) return 'Date unknown';
        try {
            const date = new Date(dateTimeString);
             // Check if date is valid after parsing
            if (isNaN(date.getTime())) {
                throw new Error("Invalid date-time value");
            }
            return date.toLocaleString('en-US', { // Use locale string for combined date and time
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true // Use AM/PM
            });
        } catch (e) {
            console.error(`Error formatting datetime "${dateTimeString}":`, e);
            return 'Invalid Date/Time'; // Return a clear indicator of error
        }
    }

    // --- Task Details Popup Functionality ---

    
    // --- Task Details Popup Functionality ---

    /**
     * Populates and displays the task details modal.
     * @param {object} taskData - The task data object.
     * @param {string} context - The context from which the modal is opened ('pending' or 'lookup').
     */
    function showTaskDetailsPopup(taskData, context = 'pending') {
        const modal = document.getElementById('task-details-modal');
        if (!modal || !taskData) {
            console.error("Task details modal or task data is missing.");
            return;
        }

        console.log(`Showing task details popup for task ID: ${taskData.task_id}, context: ${context}`);

        // Add/remove class based on context (affects history column visibility)
        modal.classList.toggle('modal-context-pending', context === 'pending');
        modal.classList.toggle('history-unavailable', !taskData.changing_entities || taskData.changing_entities.length === 0);

        // --- Populate Basic Task Info ---
        document.getElementById('modal-task-title').textContent = escapeHtml(taskData.task_title || 'Untitled Task');
        document.getElementById('modal-task-description').textContent = escapeHtml(taskData.task_description || 'No description provided.');
        document.getElementById('modal-task-assigned-by').textContent = escapeHtml(taskData.assigned_by || 'N/A');
        document.getElementById('modal-task-assigned-to').textContent = escapeHtml(taskData.assigned_to_name || taskData.assigned_to || 'N/A'); // Prefer name if available

        // --- Populate Dates (and hide if in lookup context) ---
        const startDateElement = document.getElementById('modal-task-start-date');
        const dueDateElement = document.getElementById('modal-task-due-date');
        const startDateRow = startDateElement?.closest('.task-info-detail'); // Optional chaining
        const dueDateRow = dueDateElement?.closest('.task-info-detail');

        if (startDateElement) startDateElement.textContent = formatDateTime(taskData.created_at);
        if (dueDateElement) dueDateElement.textContent = formatDate(taskData.due_date);

        // Hide date rows if opened from task lookup
        startDateRow?.classList.toggle('hidden-in-lookup', context === 'lookup');
        dueDateRow?.classList.toggle('hidden-in-lookup', context === 'lookup');

        // --- Populate Status ---
        const statusSpan = document.getElementById('modal-task-status');
        const statusText = taskData.status || 'Unknown';
        const statusClass = getStatusClass(statusText); // Use helper function
        statusSpan.textContent = escapeHtml(statusText);
        statusSpan.className = `task-info-status ${statusClass}`; // Apply base and status-specific class
        statusSpan.style.display = (statusText === 'Unknown') ? 'none' : 'inline-block';

        // --- Populate Task History Timeline ---
        const timelineContainer = document.getElementById('task-timeline');
        if (timelineContainer) {
            if (taskData.changing_entities && Array.isArray(taskData.changing_entities) && taskData.changing_entities.length > 0) {
                // Sort history items newest first
                const sortedItems = [...taskData.changing_entities].sort((a, b) => new Date(b.update_date) - new Date(a.update_date));

                let timelineHTML = '<div class="timeline-track"></div>'; // Start with the track
                sortedItems.forEach(item => {
                    const formattedDate = formatDateTime(item.update_date);
                    const itemStatusClass = getStatusClass(item.status); // Get class for history item status
                    timelineHTML += `
                        <div class="timeline-item">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <div class="timeline-status ${itemStatusClass}">${escapeHtml(item.status)}</div>
                                <div class="timeline-date">${formattedDate}</div>
                                ${item.feedback ? `<div class="timeline-feedback">${escapeHtml(item.feedback)}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                timelineContainer.innerHTML = timelineHTML;
            } else {
                // Display message if no history
                timelineContainer.innerHTML = `
                    <div class="timeline-track"></div>
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-status">No history available for this task.</div>
                        </div>
                    </div>
                `;
            }
        } else {
            console.error("Timeline container not found.");
        }


        // --- Populate Feedback Section (only for pending context) ---
        const feedbackContainer = document.getElementById('modal-task-feedback-container');
        const feedbackTextElement = document.getElementById('modal-task-feedback');
        if (feedbackContainer && feedbackTextElement) {
            if (context === 'pending') {
                const latestFeedback = taskData.feedback && String(taskData.feedback).trim() !== '' ? taskData.feedback : null;
                console.log("Latest feedback for pending task:", latestFeedback);
                if (latestFeedback) {
                    feedbackTextElement.textContent = escapeHtml(latestFeedback);
                    feedbackContainer.style.display = 'block'; // Show container only if feedback exists
                } else {
                     feedbackTextElement.textContent = ''; // Clear any previous feedback
                     feedbackContainer.style.display = 'none'; // Hide if no feedback
                }
            } else {
                feedbackContainer.style.display = 'none'; // Hide feedback in lookup context
                feedbackTextElement.textContent = '';
            }
        } else {
             console.error("Feedback container or text element not found in modal.");
        }


        // --- Configure Action Buttons Based on User Role and Task Status ---
        const completeButton = document.getElementById('modal-raise-approval-btn');
        const requestChangesButton = document.getElementById('modal-request-changes-btn');
        const completeButtonText = completeButton?.querySelector('span'); // Optional chaining

        if (!completeButton || !requestChangesButton || !completeButtonText) {
            console.error("Modal action buttons or button text span not found.");
            // Optionally hide the modal or show an error if buttons are critical
            // modal.classList.remove('active');
            // showNotification("Error: Modal buttons missing.", "error");
            // return; // Stop further execution if buttons are missing
        } else {
            // Reset buttons state
            completeButton.style.display = 'none';
            completeButton.disabled = true;
            completeButton.dataset.action = '';
            completeButton.dataset.taskId = taskData.task_id; // Always set task ID

            requestChangesButton.style.display = 'none';
            requestChangesButton.disabled = true;
            requestChangesButton.dataset.taskId = taskData.task_id; // Always set task ID

            // Determine user role relative to the task
            const currentUserId = document.getElementById('user-id')?.value; // Optional chaining
            if (!currentUserId) {
                 console.error("Could not determine current user ID.");
                 // Handle error appropriately, maybe disable actions
            } else {
                const isAssignee = String(taskData.assigned_to) === String(currentUserId);
                const isAssigner = String(taskData.assigned_by_id) === String(currentUserId);
                const isSelfAssigned = String(taskData.assigned_by_id) === String(taskData.assigned_to);

                console.log(`Button logic check: isAssignee=${isAssignee}, isAssigner=${isAssigner}, isSelfAssigned=${isSelfAssigned}, status=${taskData.status}`);

                // Logic for Assignee actions
                if (isAssignee && (taskData.status === 'In Progress' || taskData.status === 'Updates Requested')) {
                    if (isSelfAssigned) {
                        completeButtonText.textContent = 'Mark as Complete';
                        completeButton.dataset.action = 'complete';
                    } else {
                        completeButtonText.textContent = 'Raise for Approval';
                        completeButton.dataset.action = 'raise_approval';
                    }
                    completeButton.style.display = 'inline-flex';
                    completeButton.disabled = false;
                    console.log(`Assignee action button configured: ${completeButton.dataset.action}`);
                }
                // Logic for Assigner actions
                else if (isAssigner && taskData.status === 'pending approval') {
                    // Assigner can complete or request changes
                    completeButtonText.textContent = 'Mark as Complete';
                    completeButton.dataset.action = 'complete';
                    completeButton.style.display = 'inline-flex';
                    completeButton.disabled = false;

                    requestChangesButton.style.display = 'inline-flex';
                    requestChangesButton.disabled = false;
                    console.log("Assigner action buttons configured: complete & request_changes");
                }
            }
        }

        // --- Show Modal ---
        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
        console.log("Task details popup displayed.");
    }

    // --- DOMContentLoaded Initialization ---

    
    // --- DOMContentLoaded Initialization ---

    /**
     * Main initialization function run after the DOM is fully loaded.
     */
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM Content Loaded - Initializing application components...');

        // Initialize UI components and event listeners
        initializeTaskLookup();             // Setup task search functionality
        initializeRefreshButton();          // Setup refresh button for pending tasks
        initializeModal();                  // Setup general modal open/close behavior
        initializeFeedbackModal();          // Setup feedback modal form submission
        initializeClientForm();             // Setup add client form validation and submission
        initializeLeadForm();               // Setup add lead form validation and submission
        initializeProductForm();            // Setup add product form validation and submission
        initializeUserForm();               // Setup add user form validation and submission
        initializeAssignTaskForm();         // Setup assign task form validation and submission
        initializeTaskCarousel();           // Setup pending tasks carousel navigation
        initializeTaskPopupInteraction();   // Setup click handlers for task cards and modal buttons
        initializeTaskExpandCollapse();     // Setup expand/collapse for the tasks section
        initializeHeaderScrollEffect();     // Add scroll effect to the header
        addDateIconListener();              // Make calendar icons in date inputs clickable

        // Populate dynamic dropdowns with data from the server
        populateRoles();                    // Populate role selection in add user modal
        populateTeams();                    // Populate team selection in add user modal
        populateAssigneeDropdown();         // Populate assignee selection in assign task modal

        // Fetch initial data required for the dashboard
        fetchAndDisplayTasks();             // Load and display pending tasks for the current user

        // Log user info for debugging purposes (consider removing in production)
        const userIdInput = document.getElementById('user-id');
        console.log("User ID on load:", userIdInput ? userIdInput.value : 'Element not found');
    });

    // --- UI Initialization Functions ---

    /**
     * Adds a scroll effect to the header (e.g., add a 'scrolled' class).
     */
    function initializeHeaderScrollEffect() {
        const header = document.querySelector('.header');
        if (!header) {
            console.warn("Header element not found for scroll effect.");
            return; // Exit if header element doesn't exist
        }

        // Add event listener to the window's scroll event
        window.addEventListener('scroll', () => {
            // Toggle the 'scrolled' class on the header based on scroll position
            // Adds the class if scrolled more than 10px down, removes it otherwise
            header.classList.toggle('scrolled', window.scrollY > 10);
        }, { passive: true }); // Use passive listener for better scroll performance

        console.log("Header scroll effect initialized.");
    }

    /**
     * Initializes the feedback modal form submission and cancel button.
     */
    function initializeFeedbackModal() {
        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackForm = document.getElementById('feedback-form');

        if (!feedbackModal || !feedbackForm) {
            console.error("Feedback modal or form element not found.");
            return; // Exit if essential elements are missing
        }

        // Handle feedback form submission
        feedbackForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent the browser's default form submission

            // Get references to form elements and their values
            const feedbackTextArea = document.getElementById('feedback-text');
            const taskIdInput = document.getElementById('feedback-task-id');
            const dueDateInput = document.getElementById('feedback-due-date'); // Optional new due date
            const feedbackText = feedbackTextArea.value.trim();
            const taskId = taskIdInput.value;
            const newDueDate = dueDateInput.value;

            // Basic validation: Ensure feedback text is provided
            if (!feedbackText) {
                markInvalid(feedbackTextArea, 'Feedback cannot be empty.'); // Mark field as invalid
                return; // Stop submission if validation fails
            } else {
                clearInvalid(feedbackTextArea); // Clear any previous invalid state
            }

            // Proceed with submission if task ID is present
            if (taskId) {
                console.log(`Submitting feedback for task ${taskId} with new due date: ${newDueDate || 'none'}`);
                // Call the function to handle the actual API request
                submitFeedback(taskId, feedbackText, newDueDate, this); // Pass form element for button state management
            } else {
                console.error("Task ID missing in feedback form.");
                showNotification("Error: Could not identify task to submit feedback for.", "error");
            }
        });

        // Handle modal close/cancel button click
        const cancelBtn = feedbackModal.querySelector('.cancel-modal');
        if (cancelBtn) {
            // Use the generic closeActiveModal function when cancel is clicked
            cancelBtn.addEventListener('click', () => closeActiveModal('feedback-modal'));
        }

        // Optional: Add a listener to clear the optional due date when the modal is closed.
        // This relies on the 'closeActiveModal' function (or its mechanism) dispatching
        // a custom event named 'modalClosed' on the modal element.
        feedbackModal.addEventListener('modalClosed', () => { // Assuming 'modalClosed' event is dispatched
            const dueDateInput = document.getElementById('feedback-due-date');
            if (dueDateInput) {
                dueDateInput.value = ''; // Clear the optional due date field
            }
            console.log("Feedback modal closed, optional due date cleared.");
        });

        console.log("Feedback modal initialized.");
    }

    // --- Data Fetching and Display ---

    /**
     * Fetches pending tasks for the current user and displays them in the carousel.
     */
    function fetchAndDisplayTasks() {
        const tasksContainer = document.getElementById('tasks-list-container');
        const loadingMessage = document.getElementById('loading-tasks-message');
        const userIdInput = document.getElementById('user-id');
        const expandBtn = document.getElementById('expand-tasks-btn');

        // Ensure essential elements are present
        if (!tasksContainer || !loadingMessage) {
            console.error("Tasks container or loading message element not found.");
            return;
        }
        // Validate user ID before proceeding
        if (!userIdInput || !userIdInput.value || userIdInput.value === 'None' || userIdInput.value === 'undefined') {
            console.error("Invalid or missing User ID:", userIdInput?.value); // Use optional chaining for safety
            loadingMessage.textContent = 'Session error. Please login again.';
            showNotification('Session expired or invalid. Please log in again.', 'error');
            // Consider redirecting to login page after a delay
            // setTimeout(() => { window.location.href = '/'; }, 2000);
            return;
        }

        const userId = userIdInput.value;
        console.log(`Fetching pending tasks for user ID: ${userId}`);

        // Prepare UI for loading state
        loadingMessage.style.display = 'block'; // Show the loading indicator
        tasksContainer.innerHTML = '';          // Clear any previously displayed tasks
        if (expandBtn) expandBtn.classList.add('hidden'); // Hide expand button until task count is known

        // Fetch tasks from the backend API
        fetch('/get-tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // Include user ID and potentially username (if needed by backend)
            body: JSON.stringify({ user_id: userId, Username: localStorage.getItem('ilnb_uname') })
        })
        .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err))) // Handle both network and application errors
        .then(data => {
            loadingMessage.style.display = 'none'; // Hide loading indicator
            console.log("Received tasks data:", data);

            // Validate the response structure
            if (!data || !data.hasOwnProperty('success')) {
                 throw new Error("Invalid response format from server.");
            }

            // Handle unsuccessful response from the backend (e.g., user not found, DB error)
            if (!data.success) {
                const message = data.message || 'No pending tasks found.'; // Use default message if none provided
                // Display the message in the tasks container
                tasksContainer.innerHTML = `<p style="text-align: center; padding: 20px; color: var(--text-secondary);">${escapeHtml(message)}</p>`;
                // Show a notification unless it's just the "no tasks found" message
                if (message !== 'No pending tasks found.') {
                    showNotification(`Could not load tasks: ${escapeHtml(message)}`, 'warning');
                }
                return; // Stop processing if the request was not successful
            }

            // Process successful response with task data
            if (data.data && data.data.length > 0) {
                // Sort tasks: Overdue first, then by due date ascending, then tasks without dates
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Set to start of today for accurate comparison

                data.data.sort((a, b) => {
                    const dateA = a.due_date ? new Date(a.due_date) : null;
                    const dateB = b.due_date ? new Date(b.due_date) : null;
                    if (dateA) dateA.setHours(0, 0, 0, 0); // Normalize date A
                    if (dateB) dateB.setHours(0, 0, 0, 0); // Normalize date B

                    const isAOverdue = dateA && dateA < today;
                    const isBOverdue = dateB && dateB < today;

                    if (isAOverdue !== isBOverdue) return isAOverdue ? -1 : 1; // Prioritize overdue tasks
                    if (dateA && dateB) return dateA - dateB;                 // Sort by due date ascending
                    if (dateA) return -1;                                     // Tasks with dates come before those without
                    if (dateB) return 1;
                    return 0;                                                 // Keep original order if dates are same/null
                });

                // Create and append task card elements for each task
                data.data.forEach(task => {
                    const taskCard = createTaskCard(task); // Use helper function to create card
                    tasksContainer.appendChild(taskCard);
                });

                // Show the 'Expand' button only if there are more than 4 tasks
                if (expandBtn && data.data.length > 4) {
                    expandBtn.classList.remove('hidden');
                }

            } else {
                // Display message if the data array is empty
                tasksContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-secondary);">No pending tasks found.</p>';
            }

            // Re-initialize the task carousel to update its state (arrows, scrollability)
            initializeTaskCarousel(); // Or call a specific update function if available

        })
        .catch(error => {
            // Handle fetch errors (network issues, JSON parsing errors, etc.)
            console.error('Error fetching tasks:', error);
            loadingMessage.style.display = 'none'; // Hide loading indicator
            // Display error message in the tasks container
            tasksContainer.innerHTML = `<p style="text-align: center; padding: 20px; color: var(--due-date-past);">Error loading tasks: ${escapeHtml(error.message)}</p>`;
            showNotification(`Error loading tasks: ${error.message}`, 'error'); // Show error notification
            if (expandBtn) expandBtn.classList.add('hidden'); // Ensure expand button is hidden on error
        });
    }

    /**
     * Creates an HTML element for a single task card.
     * @param {object} task - The task data object.
     * @returns {HTMLElement} The created task card element.
     */
    function createTaskCard(task) {
        // Create the main div element for the task card
        const card = document.createElement('div');
        card.className = 'task-card clickable-task-card'; // Add classes for styling and clickability
        card.dataset.taskId = task.task_id; // Store the task ID in a data attribute for easy access

        // Store the full task details as a JSON string in another data attribute.
        // This allows the details popup to access all task info without another fetch.
        try {
            card.dataset.taskDetails = JSON.stringify(task);
        } catch (e) {
            // Handle cases where task data might not be serializable (though unlikely here)
            console.error("Failed to stringify task details for card:", task, e);
            card.dataset.taskDetails = '{}'; // Provide an empty object as fallback
        }

        // Get styling class and formatted text for the due date using a helper function
        const { dueDateClass, formattedDueDate } = getDueDateInfo(task.due_date);
        // Determine the status text and its corresponding CSS class
        const statusText = task.status || 'Unknown'; // Default to 'Unknown' if status is missing
        const statusClass = getStatusClass(statusText); // Get CSS class based on status

        // Set the inner HTML of the card using a template literal
        card.innerHTML = `
            <h4 class="task-title">${escapeHtml(task.task_title || 'Untitled Task')}</h4> <!-- Display task title (escaped) -->
            <div class="task-card-footer">
                <span class="task-status ${statusClass}">${escapeHtml(statusText)}</span> <!-- Display status with class -->
                <span class="task-due-date ${dueDateClass}">Due: ${formattedDueDate}</span> <!-- Display due date with class -->
            </div>
        `;

        // Return the fully constructed card element
        return card;
    }

    /**
     * Calculates due date status class and formatted date string.
     * @param {string} dueDateStr - The due date string.
     * @returns {object} Object containing dueDateClass and formattedDueDate.
     */
    function getDueDateInfo(dueDateStr) {
        // Handle cases where the due date string is missing or empty
        if (!dueDateStr) {
            return { dueDateClass: '', formattedDueDate: 'N/A' }; // Return default values
        }

        try {
            // Attempt to parse the due date string into a Date object
            const dueDate = new Date(dueDateStr);
            // Check if the parsed date is valid
            if (isNaN(dueDate.getTime())) {
                throw new Error("Invalid date value provided");
            }

            // Get today's date and the date three days from now for comparison
            const today = new Date();
            const threeDaysFromNow = new Date();
            threeDaysFromNow.setDate(today.getDate() + 3);

            // Normalize dates to compare only the date part (ignore time)
            dueDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            threeDaysFromNow.setHours(0, 0, 0, 0);

            // Determine the appropriate CSS class based on the due date
            let dueDateClass = 'due-date-ok'; // Default class
            if (dueDate < today) {
                dueDateClass = 'due-date-past'; // Task is overdue
            } else if (dueDate <= threeDaysFromNow) {
                dueDateClass = 'due-date-soon'; // Task is due within the next 3 days
            }

            // Format the due date string using the formatDate helper function
            const formattedDueDate = formatDate(dueDateStr);

            // Return the calculated class and formatted date string
            return { dueDateClass, formattedDueDate };

        } catch (e) {
            // Handle errors during date parsing or processing
            console.error(`Error processing due date "${dueDateStr}":`, e);
            // Return default values indicating an invalid date
            return { dueDateClass: '', formattedDueDate: 'Invalid Date' };
        }
    }

    // --- Task Actions (Approval, Completion, Request Changes) ---
   
   /**
    * Handles the action when an assignee clicks "Raise for Approval".
    * Updates the task status to 'pending approval' via API call.
    * @param {string} taskId - The ID of the task to update.
    * @param {HTMLElement} buttonElement - The button element that was clicked.
    */
   function handleTaskAction(taskId, buttonElement) {
        const buttonTextSpan = buttonElement.querySelector('span'); // Get the text span inside the button

        console.log(`Raise for Approval action initiated for task ID: ${taskId}`);
        showNotification(`Requesting approval for task ${taskId.substring(0, 8)}...`, 'info'); // Show feedback

        // Update button state to indicate processing
        if (buttonTextSpan) buttonTextSpan.textContent = 'Requesting...';
        buttonElement.disabled = true; // Disable button during request

        // Make API call to update the task status
        fetch('/update-task-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: taskId, new_status: 'pending approval' }) // Set new status
        })
        .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err))) // Handle response
        .then(data => {
            if (data.success) {
                // On success: show notification, close modal, refresh task list
                showNotification(`Task ${taskId.substring(0, 8)} submitted for approval.`, 'success');
                closeActiveModal('task-details-modal'); // Close the details popup
                fetchAndDisplayTasks(); // Refresh the pending tasks list
            } else {
                // If API call failed (but network request succeeded), throw error
                throw new Error(data.message || 'Failed to request approval');
            }
        })
        .catch(error => {
            // Handle network errors or errors thrown from .then()
            console.error('Error raising approval:', error);
            showNotification(`Error: ${error.message}`, 'error'); // Show error notification
            // Restore button state on error
            if (buttonTextSpan) buttonTextSpan.textContent = 'Raise for Approval';
            buttonElement.disabled = false;
        });
   }

   /**
    * Handles the action when a task is marked as complete (either by assignee for self-assigned tasks or by assigner).
    * Updates the task status to 'Completed' via API call.
    * @param {string} taskId - The ID of the task to update.
    * @param {HTMLElement} buttonElement - The button element that was clicked.
    */
   function handleMarkAsComplete(taskId, buttonElement) {
        const buttonTextSpan = buttonElement.querySelector('span'); // Get the text span

        console.log(`Mark as Complete action initiated for task ID: ${taskId}`);
        showNotification(`Marking task ${taskId.substring(0, 8)} as complete...`, 'info'); // Show feedback

        // Update button state to indicate processing
        if (buttonTextSpan) buttonTextSpan.textContent = 'Completing...';
        buttonElement.disabled = true; // Disable button

        // Make API call to update the task status to 'Completed'
        fetch('/update-task-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: taskId, new_status: 'Completed' })
        })
        .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err))) // Handle response
        .then(data => {
            if (data.success) {
                // On success: show notification, close modal, refresh task list
                showNotification(`Task ${taskId.substring(0, 8)} marked as complete.`, 'success');
                closeActiveModal('task-details-modal'); // Close the details popup
                fetchAndDisplayTasks(); // Refresh the pending tasks list
            } else {
                // If API call failed, throw error
                throw new Error(data.message || 'Failed to mark task as complete');
            }
        })
        .catch(error => {
            // Handle network errors or errors thrown from .then()
            console.error('Error marking task complete:', error);
            showNotification(`Error: ${error.message}`, 'error'); // Show error notification
            // Restore button state on error
            if (buttonTextSpan) buttonTextSpan.textContent = 'Mark as Complete';
            buttonElement.disabled = false;
        });
    }

    /**
     * Handles the action when an assigner clicks "Request Changes".
     * Opens the feedback modal, pre-populating the task ID.
     * @param {string} taskId - The ID of the task for which changes are requested.
     */
    function handleRequestChanges(taskId) {
        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackTaskIdInput = document.getElementById('feedback-task-id');
        const feedbackTextArea = document.getElementById('feedback-text');
        const feedbackDueDateInput = document.getElementById('feedback-due-date'); // Get the optional due date input

        // Ensure all necessary elements for the feedback modal exist
        if (feedbackModal && feedbackTaskIdInput && feedbackTextArea && feedbackDueDateInput) {
            // Pre-populate the hidden task ID input in the feedback form
            feedbackTaskIdInput.value = taskId;
            // Clear any previous feedback text and validation errors
            feedbackTextArea.value = '';
            clearInvalid(feedbackTextArea);
            // Clear the optional new due date field
            feedbackDueDateInput.value = '';

            // Open the feedback modal
            feedbackModal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scroll

            // Close the task details modal from which this was triggered
            closeActiveModal('task-details-modal');
            console.log(`Opened feedback modal for task ID: ${taskId}`);
        } else {
            // Log an error and notify the user if elements are missing
            console.error("Feedback modal elements (modal, task ID input, text area, or due date input) not found.");
            showNotification("Error opening feedback form.", "error");
        }
    }

    /**
     * Escapes HTML special characters in a string to prevent XSS.
     * @param {string} unsafe - The potentially unsafe string.
     * @returns {string} The escaped string, or the original input if not a string.
     */
    function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') return unsafe; 
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}


/**
 * Initializes event listeners for task popup interactions:
 * - Clicking a task card in the carousel to show details.
 * - Clicking the "Complete" / "Raise Approval" button in the details modal.
 * - Clicking the "Request Changes" button in the details modal.
 */
function initializeTaskPopupInteraction() {
    const tasksContainer = document.getElementById('tasks-list-container'); // Container for pending task cards
    const completeButton = document.getElementById('modal-raise-approval-btn'); // Button in details modal for completion/approval
    const requestChangesButton = document.getElementById('modal-request-changes-btn'); // Button in details modal to request changes

    // Listener for clicks within the tasks container (delegated)
    if (tasksContainer) {
        tasksContainer.addEventListener('click', (event) => {
            // Find the closest ancestor that is a clickable task card
            const clickedCard = event.target.closest('.clickable-task-card');
            if (clickedCard) {
                // Retrieve the task details stored in the card's dataset
                const taskDetailsJson = clickedCard.dataset.taskDetails;
                if (taskDetailsJson) {
                    try {
                        // Parse the JSON data
                        const taskData = JSON.parse(taskDetailsJson);
                        // Show the task details popup using the parsed data
                        showTaskDetailsPopup(taskData, 'pending'); // Context is 'pending' as it's from the pending list
                    } catch (e) {
                        console.error("Failed to parse task details from card:", taskDetailsJson, e);
                        showNotification("Could not load task details.", "error");
                    }
                } else {
                    console.warn("Task card clicked, but no task details found in dataset.");
                }
            }
        });
    } else {
        console.warn("Tasks container not found for popup interaction listener.");
    }

    // Listener for the "Complete" / "Raise Approval" button
    if (completeButton) {
        completeButton.addEventListener('click', (event) => {
            const button = event.currentTarget;
            const taskId = button.dataset.taskId; // Get task ID from button's dataset
            const action = button.dataset.action; // Get action type (complete/raise_approval)

            if (taskId && action) {
                // Call the appropriate handler based on the action
                if (action === 'complete') {
                    handleMarkAsComplete(taskId, button);
                } else if (action === 'raise_approval') {
                    handleTaskAction(taskId, button); // This function handles the 'raise_approval' action
                } else {
                    console.error("Unknown action type on modal button:", action);
                    showNotification("Error: Unknown button action.", "error");
                }
            } else {
                console.error("Task ID or action not found on modal button.");
                showNotification("Error: Could not identify task or action.", "error");
            }
        });
    } else {
        console.warn("Modal complete/raise button (#modal-raise-approval-btn) not found.");
    }

    // Listener for the "Request Changes" button
    if (requestChangesButton) {
        requestChangesButton.addEventListener('click', (event) => {
            const button = event.currentTarget;
            const taskId = button.dataset.taskId; // Get task ID from button's dataset
            if (taskId) {
                handleRequestChanges(taskId); // Call the handler to open the feedback modal
            } else {
                console.error("Task ID not found on request changes button.");
                showNotification("Error: Could not identify task for requesting changes.", "error");
            }
        });
    } else {
        console.warn("Modal request changes button (#modal-request-changes-btn) not found.");
    }
}


/**
 * Closes the specified modal if it is currently active.
 * It attempts to trigger the modal's close mechanism by simulating a click
 * on the backdrop or a cancel button. If those aren't found, it directly
 * removes the 'active' class. It also resets the body overflow.
 * @param {string} modalId - The ID of the modal element to close.
 */
function closeActiveModal(modalId) {
    const modal = document.getElementById(modalId);
    // Check if the modal exists and is currently active
    if (modal && modal.classList.contains('active')) {
        // Try to find the backdrop and a cancel button within the modal
        const backdrop = modal.querySelector('.modal-backdrop');
        const cancelBtn = modal.querySelector('.cancel-modal'); // Assumes a common class for cancel buttons

        // Preferentially trigger the backdrop click (which should handle cleanup)
        if (backdrop) {
            backdrop.click();
        }
        // Otherwise, try clicking a cancel button
        else if (cancelBtn) {
            cancelBtn.click();
        }
        // As a fallback, directly remove the active class and restore body scroll
        else {
            console.warn(`Could not find backdrop or cancel button for modal ${modalId}. Closing directly.`);
            modal.classList.remove('active');
            document.body.style.overflow = ''; // Restore scrolling on the body
        }
        console.log(`Attempted to close modal: ${modalId}`);
    }
}


/**
 * Submits feedback for a task when changes are requested.
 * Updates the task status to 'Updates Requested', adds the feedback text,
 * and optionally sets a new due date via an API call.
 * @param {string} taskId - The ID of the task to update.
 * @param {string} feedbackText - The feedback provided by the user.
 * @param {string|null} newDueDate - The optional new due date selected by the user.
 * @param {HTMLFormElement} formElement - The feedback form element itself, used to manage button state.
 */
function submitFeedback(taskId, feedbackText, newDueDate, formElement) {
    // Get references to the submit button and its internal elements
    const submitBtn = formElement.querySelector('button[type="submit"]');
    const submitTextSpan = submitBtn?.querySelector('span'); // Optional chaining for safety
    const loadingSpinner = submitBtn?.querySelector('.loading-spinner');

    // Log the action and show an initial notification
    console.log(`Submitting feedback for task ID: ${taskId}`);
    showNotification(`Submitting feedback for task ${taskId.substring(0, 8)}...`, 'info');

    // Update button state to indicate processing
    if (submitTextSpan) submitTextSpan.textContent = 'Submitting...';
    if (submitBtn) submitBtn.disabled = true;
    if (loadingSpinner) loadingSpinner.classList.add('visible');

    // Prepare the data payload for the API request
    const payload = {
        task_id: taskId,
        new_status: 'Updates Requested', // Set the new status
        feedback: feedbackText // Include the feedback text
    };

    // Add the new due date to the payload if it was provided
    if (newDueDate) {
        payload.new_due_date = newDueDate;
        console.log(`Including new due date: ${newDueDate}`);
    }

    // Make the API call to the backend endpoint
    fetch('/update-task-status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload) // Send the payload as JSON
    })
    .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err))) // Handle response and potential errors
    .then(data => {
        if (data.success) {
            // On successful submission:
            showNotification(`Changes requested for task ${taskId.substring(0, 8)}.`, 'success');
            closeActiveModal('feedback-modal'); // Close the feedback modal
            fetchAndDisplayTasks(); // Refresh the pending tasks list to reflect the change
        } else {
            // If the API indicates failure, throw an error
            throw new Error(data.message || 'Failed to submit feedback');
        }
    })
    .catch(error => {
        // Handle network errors or errors thrown from the .then() block
        console.error('Error submitting feedback:', error);
        showNotification(`Error: ${error.message}`, 'error'); // Show error notification
        // Restore the submit button to its original state
        if (submitTextSpan) submitTextSpan.textContent = 'Submit Feedback';
        if (submitBtn) submitBtn.disabled = false;
        if (loadingSpinner) loadingSpinner.classList.remove('visible');
    });
}


/**
 * Validates an email input field.
 * Checks if it's required and empty, or if the format is invalid.
 * Marks the input as invalid and displays an error message if validation fails.
 * @param {HTMLInputElement} input - The email input element.
 * @returns {boolean} True if valid, false otherwise.
 */
function validateEmail(input) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; // Standard email regex
    const value = input.value.trim();
    const isRequired = input.hasAttribute('required');

    if (isRequired && value === '') {
        markInvalid(input, 'This field is required');
        return false;
    } else if (value !== '' && !emailRegex.test(value)) {
        markInvalid(input, 'Please enter a valid email address');
        return false;
    } else {
        clearInvalid(input); // Clear any previous error state
        return true;
    }
}

/**
 * Validates a mobile number input field (assuming 10 digits).
 * Checks if it's required and empty, or if the format is invalid.
 * Marks the input as invalid and displays an error message if validation fails.
 * @param {HTMLInputElement} input - The mobile number input element.
 * @returns {boolean} True if valid, false otherwise.
 */
function validateMobile(input) {
    const mobileRegex = /^\d{10}$/; // Regex for exactly 10 digits
    const value = input.value.trim();
    const isRequired = input.hasAttribute('required');

    if (isRequired && value === '') {
        markInvalid(input, 'This field is required');
        return false;
    } else if (value !== '' && !mobileRegex.test(value)) {
        markInvalid(input, 'Please enter a valid 10-digit mobile number');
        return false;
    } else {
        clearInvalid(input); // Clear any previous error state
        return true;
    }
}

/**
 * Validates a PAN (Permanent Account Number) input field (Indian format).
 * Converts input to uppercase. Checks if it's required and empty, or if the format is invalid.
 * Marks the input as invalid and displays an error message if validation fails.
 * @param {HTMLInputElement} input - The PAN input element.
 * @returns {boolean} True if valid, false otherwise.
 */
function validatePAN(input) {
    const panRegex = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/; // Regex for Indian PAN format
    input.value = input.value.toUpperCase(); // Ensure uppercase for validation
    const value = input.value.trim();
    const isRequired = input.hasAttribute('required');

    if (isRequired && value === '') {
        markInvalid(input, 'This field is required');
        return false;
    } else if (value !== '' && !panRegex.test(value)) {
        markInvalid(input, 'Please enter a valid PAN (e.g., ABCDE1234F)');
        return false;
    } else {
        clearInvalid(input); // Clear any previous error state
        return true;
    }
}


/**
 * Initializes general modal behavior: opening modals when trigger cards are clicked,
 * and closing modals via backdrop click, cancel buttons, or the Escape key.
 * Also handles resetting form states within modals upon closing.
 */
function initializeModal() {
    const allModals = document.querySelectorAll('.modal'); // Get all modal elements
    // Define pairs of trigger card IDs and their corresponding modal IDs
    const modalTriggers = [
        { cardId: 'add-client-card', modalId: 'add-client-modal' },
        { cardId: 'add-lead-card', modalId: 'add-lead-modal' },
        { cardId: 'add-product-card', modalId: 'add-product-modal' },
        { cardId: 'add-users-card', modalId: 'add-user-modal' },
        { cardId: 'assign-task-card', modalId: 'assign-task-modal' },
        { cardId: 'task-lookup-card', modalId: 'task-lookup-modal' }
        // Add other modal triggers here if needed
    ];

    // --- Setup Modal Opening ---
    modalTriggers.forEach(trigger => {
        const card = document.getElementById(trigger.cardId);
        const modal = document.getElementById(trigger.modalId);

        // Add click listener to each trigger card
        if (card && modal) {
            card.addEventListener('click', function() {
                console.log(`Opening modal: ${trigger.modalId}`);
                modal.classList.add('active'); // Show the modal
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
                // Optional: Focus the first input field in the modal
                const firstInput = modal.querySelector('input:not([type="hidden"]), select, textarea');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 100); // Delay focus slightly for transition
                }
            });
        } else {
            if (!card) console.warn(`Modal trigger card not found: #${trigger.cardId}`);
            if (!modal) console.warn(`Modal element not found: #${trigger.modalId}`);
        }
    });

    // --- Setup Modal Closing ---
    allModals.forEach(modal => {
        const modalBackdrop = modal.querySelector('.modal-backdrop');
        const cancelModalBtns = modal.querySelectorAll('.cancel-modal'); // Common class for cancel buttons
        const closeModalHeaderBtn = modal.querySelector('.modal-header .close-modal'); // Optional header close button
        const modalContainer = modal.querySelector('.modal-container');
        const form = modal.querySelector('form'); // Find form within the modal

        // Function to handle closing the modal and resetting its state
        const closeModal = function() {
            if (!modal.classList.contains('active')) return; // Prevent closing if already closed

            console.log(`Closing modal: ${modal.id}`);
            modal.classList.remove('active');
            document.body.style.overflow = ''; // Restore background scrolling

            // Dispatch a custom event before resetting the form (e.g., for feedback modal cleanup)
            modal.dispatchEvent(new CustomEvent('modalClosed', { bubbles: true }));

            // Reset form elements after a short delay (allows closing animation)
            if (form) {
                setTimeout(() => {
                    form.reset(); // Reset form fields to default values
                    // Clear validation errors
                    const errorMessages = modal.querySelectorAll('.error-message');
                    errorMessages.forEach(error => {
                        error.classList.remove('visible');
                        error.textContent = '';
                    });
                    const invalidInputs = modal.querySelectorAll('.form-control.invalid');
                    invalidInputs.forEach(input => input.classList.remove('invalid'));

                    // Reset submit button state
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        const submitText = submitBtn.querySelector('span');
                        const loadingSpinner = submitBtn.querySelector('.loading-spinner');
                        // Restore original button text if stored, otherwise use a default based on modal ID
                        if (submitText && submitBtn.dataset.originalText) {
                            submitText.textContent = submitBtn.dataset.originalText;
                        } else if (submitText) {
                            // Fallback default text (can be improved)
                            if (modal.id === 'add-client-modal') submitText.textContent = 'Add Client';
                            else if (modal.id === 'add-lead-modal') submitText.textContent = 'Add Lead';
                            else if (modal.id === 'add-product-modal') submitText.textContent = 'Add Product';
                            else if (modal.id === 'add-user-modal') submitText.textContent = 'Add User'; // Changed from 'Create Account'
                            else if (modal.id === 'assign-task-modal') submitText.textContent = 'Assign Task';
                            else if (modal.id === 'feedback-modal') submitText.textContent = 'Submit Feedback';
                        }
                        if (loadingSpinner) loadingSpinner.classList.remove('visible');
                        submitBtn.disabled = false;
                        submitBtn.style.background = ''; // Reset background if changed on success
                    }

                    // Reset task action buttons in the details modal
                    const taskActionBtn = modal.querySelector('#modal-raise-approval-btn');
                    if (taskActionBtn) {
                        const taskBtnText = taskActionBtn.querySelector('span');
                        // Reset text, disable, hide, and clear data attributes
                        if (taskBtnText) taskBtnText.textContent = 'Action'; // Generic placeholder
                        taskActionBtn.disabled = true;
                        taskActionBtn.style.display = 'none';
                        taskActionBtn.dataset.action = '';
                        taskActionBtn.dataset.taskId = '';
                    }
                     const requestChangesBtn = modal.querySelector('#modal-request-changes-btn');
                     if (requestChangesBtn) {
                         requestChangesBtn.disabled = true;
                         requestChangesBtn.style.display = 'none';
                         requestChangesBtn.dataset.taskId = '';
                     }

                }, 300); // Delay matches typical transition duration
            }
        };

        // Add close listeners
        if (cancelModalBtns.length > 0) {
            cancelModalBtns.forEach(btn => btn.addEventListener('click', closeModal));
        }
        if (modalBackdrop) {
            modalBackdrop.addEventListener('click', closeModal);
        }
        if (closeModalHeaderBtn) {
            closeModalHeaderBtn.addEventListener('click', closeModal);
        }
        // Prevent clicks inside the modal content from closing it
        if (modalContainer) {
            modalContainer.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
    });

    // --- Setup Escape Key Listener ---
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const activeModal = document.querySelector('.modal.active'); // Find the currently active modal
            if (activeModal) {
                console.log(`Escape key pressed, closing modal: ${activeModal.id}`);
                // Attempt to close via standard mechanisms first
                const activeBackdrop = activeModal.querySelector('.modal-backdrop');
                const activeHeaderClose = activeModal.querySelector('.modal-header .close-modal');
                const activeFooterClose = activeModal.querySelector('.cancel-modal');

                if (activeBackdrop) activeBackdrop.click();
                else if (activeHeaderClose) activeHeaderClose.click();
                else if (activeFooterClose) activeFooterClose.click();
                else {
                    // Fallback if no standard close elements found
                    console.warn(`No standard close mechanism found for ${activeModal.id}. Closing directly.`);
                    activeModal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
        }
    });
    console.log("General modal open/close behavior initialized.");
}


/**
 * Initializes the "Add Client" form.
 * Sets up input validation listeners (PAN, email, mobile) on blur.
 * Handles form submission: performs validation on all required fields
 * and specific format validations, then calls the generic form submission handler.
 */
function initializeClientForm() {
    const clientForm = document.getElementById('add-client-form');
    if (!clientForm) {
        console.error("Add Client form (#add-client-form) not found.");
        return; // Exit if the form doesn't exist
    }

    // Get references to specific input fields for validation
    const panInput = document.getElementById('client-pan');
    const emailInput = document.getElementById('client-email');
    const mobileInput = document.getElementById('client-mobile');

    // Add blur event listeners for real-time format validation
    if (panInput) panInput.addEventListener('blur', () => validatePAN(panInput));
    if (emailInput) emailInput.addEventListener('blur', () => validateEmail(emailInput));
    if (mobileInput) mobileInput.addEventListener('blur', () => validateMobile(mobileInput));

    // Add submit event listener to the form
    clientForm.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default browser submission
        let isValid = true; // Flag to track overall form validity
        const requiredInputs = this.querySelectorAll('[required]'); // Get all required fields

        // Validate all required fields first
        requiredInputs.forEach(input => {
            if (!input.value.trim()) {
                markInvalid(input, 'This field is required');
                isValid = false;
            } else {
                // If required field is filled, clear potential previous error
                clearInvalid(input);
                // Perform specific format validation only if the field is not empty
                if (input.id === 'client-pan' && !validatePAN(input)) isValid = false;
                if (input.id === 'client-email' && !validateEmail(input)) isValid = false;
                if (input.id === 'client-mobile' && !validateMobile(input)) isValid = false;
            }
        });

        // If all validations pass, submit the form using the generic handler
        if (isValid) {
            console.log("Client form validation passed. Submitting...");
            handleFormSubmit(this, '/add-client', 'Add Client', 'Client Added!');
        } else {
            console.log("Client form validation failed.");
            // Optionally show a general error notification
            // showNotification("Please correct the errors in the form.", "error");
        }
    });
    console.log("Add Client form initialized.");
}


/**
 * Initializes the dynamic search functionality for the Lead Generator input.
 */
function initializeLeadGeneratorSearch() {
    const searchInput = document.getElementById('lead-generator-search');
    const resultsContainer = document.getElementById('lead-generator-results');
    const hiddenDataInput = document.getElementById('lead-generator-data');
    let searchDebounceTimer;
    let highlightedIndex = -1; // For keyboard navigation

    if (!searchInput || !resultsContainer || !hiddenDataInput) {
        console.error("Lead Generator search elements (input, results, hidden) not found.");
        return;
    }

    // --- Fetch and Display Results ---
    function fetchAndDisplay(query) {
        highlightedIndex = -1; // Reset keyboard navigation index
        if (!query) {
            resultsContainer.innerHTML = '';
            resultsContainer.classList.remove('visible');
            return;
        }

        resultsContainer.innerHTML = '<div class="loading-item">Loading...</div>';
        resultsContainer.classList.add('visible');

        fetch('/get-users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reference: query }) // Send query in the specified format
        })
        .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err)))
        .then(data => {
            resultsContainer.innerHTML = ''; // Clear loading/previous results
            if (data.success && Array.isArray(data.data) && data.data.length > 0) {
                data.data.forEach((user, index) => {
                    if (user && user.id && user.username) {
                        const item = document.createElement('div');
                        item.className = 'dynamic-result-item';
                        item.textContent = user.username;
                        item.dataset.userId = user.id;
                        item.dataset.userName = user.username; // Store username too
                        item.dataset.index = index; // Store index for keyboard nav

                        // Click listener for selecting an item
                        item.addEventListener('click', () => {
                            selectUser(user.username, user.id);
                        });
                        resultsContainer.appendChild(item);
                    }
                });
                resultsContainer.classList.add('visible');
            } else if (data.success && Array.isArray(data.data) && data.data.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results-item">No users found.</div>';
                resultsContainer.classList.add('visible');
            } else {
                console.error("Failed to fetch or parse valid user data:", data);
                resultsContainer.innerHTML = '<div class="no-results-item">Error loading users.</div>';
                resultsContainer.classList.add('visible');
            }
        })
        .catch(error => {
            console.error("Error fetching users:", error);
            resultsContainer.innerHTML = `<div class="no-results-item">Error: ${escapeHtml(error.message)}</div>`;
            resultsContainer.classList.add('visible');
        });
    }

    // --- Select User Function ---
    function selectUser(username, userId) {
        searchInput.value = username; // Set input display value
        const userData = { username: username, id: parseInt(userId, 10) };
        hiddenDataInput.value = JSON.stringify(userData); // Set hidden input JSON value
        resultsContainer.innerHTML = ''; // Clear results
        resultsContainer.classList.remove('visible'); // Hide container
        clearInvalid(searchInput); // Clear validation error on the search input
        clearInvalid(hiddenDataInput); // Clear validation error on the hidden input
        console.log("Selected Lead Generator:", hiddenDataInput.value);
    }

    // --- Event Listeners ---

    // Input event with debouncing
    searchInput.addEventListener('input', () => {
        const query = searchInput.value.trim();
        // Clear hidden input immediately if search input is cleared or changed after selection
        if (hiddenDataInput.value) {
             try {
                 const selectedData = JSON.parse(hiddenDataInput.value);
                 if (selectedData.username !== query) {
                     hiddenDataInput.value = ''; // Clear if input doesn't match selected username
                     console.log("Hidden generator data cleared due to input mismatch.");
                 }
             } catch (e) { hiddenDataInput.value = ''; /* Clear if invalid JSON */ }
        }

        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => {
            fetchAndDisplay(query);
        }, 300); // 300ms debounce
    });

    // Keyboard navigation (ArrowDown, ArrowUp, Enter)
    searchInput.addEventListener('keydown', (e) => {
        const items = resultsContainer.querySelectorAll('.dynamic-result-item');
        if (!items.length || !resultsContainer.classList.contains('visible')) {
            highlightedIndex = -1;
            return;
        }

        let newIndex = highlightedIndex;

        if (e.key === 'ArrowDown') {
            e.preventDefault(); // Prevent cursor moving in input
            newIndex = (highlightedIndex + 1) % items.length;
        } else if (e.key === 'ArrowUp') {
            e.preventDefault(); // Prevent cursor moving in input
            newIndex = (highlightedIndex - 1 + items.length) % items.length;
        } else if (e.key === 'Enter') {
            e.preventDefault(); // Prevent form submission
            if (highlightedIndex >= 0 && highlightedIndex < items.length) {
                items[highlightedIndex].click(); // Simulate click on highlighted item
            }
            return; // Exit after handling Enter
        } else if (e.key === 'Escape') {
             resultsContainer.classList.remove('visible'); // Hide on Escape
             return;
        } else {
            return; // Ignore other keys
        }

        // Remove highlight from previous item
        if (highlightedIndex >= 0) {
            items[highlightedIndex].classList.remove('highlighted');
        }
        // Add highlight to new item
        items[newIndex].classList.add('highlighted');
        // Scroll into view if necessary
        items[newIndex].scrollIntoView({ block: 'nearest', inline: 'nearest' });
        highlightedIndex = newIndex;
    });

    // Hide results when clicking outside
    document.addEventListener('click', (e) => {
        const wrapper = searchInput.closest('.dynamic-search-wrapper');
        if (wrapper && !wrapper.contains(e.target)) {
            resultsContainer.classList.remove('visible');
        }
    });

     // Clear hidden input if search input is manually cleared
     searchInput.addEventListener('change', () => { // Use change event for manual clearing
         if (searchInput.value.trim() === '') {
             hiddenDataInput.value = '';
             console.log("Hidden generator data cleared because search input is empty.");
         }
     });

    console.log("Lead Generator dynamic search initialized.");
}


/**
 * Initializes the "Add Lead" form.
 * Initializes dynamic search for generator, handles form submission.
 * Validates required fields, including the hidden generator field storing JSON data.
 */
function initializeLeadForm() {
    const leadForm = document.getElementById('add-lead-form');
    if (!leadForm) {
        console.error("Add Lead form (#add-lead-form) not found.");
        return; // Exit if the form doesn't exist
    }

    // Initialize the dynamic search input for Lead Generator
    initializeLeadGeneratorSearch(); // Call the new search initializer

    // Add submit event listener to the form
    leadForm.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default browser submission
        let isValid = true; // Flag to track overall form validity

        // Get all required fields *visible* in the form (inputs, selects, textareas)
        // Exclude the search input as we validate the hidden data input instead
        const requiredVisibleInputs = this.querySelectorAll('input[required]:not(#lead-generator-search), select[required], textarea[required]');
        // Get the hidden required input for lead generator data
        const generatorDataInput = document.getElementById('lead-generator-data');
        const generatorSearchInput = document.getElementById('lead-generator-search'); // Get the search input for marking invalid

        // Validate visible required fields first
        requiredVisibleInputs.forEach(input => {
             if (input.tagName === 'SELECT' && input.value === '') {
                 markInvalid(input, 'Please select an option');
                 isValid = false;
             } else if (input.tagName !== 'SELECT' && !input.value.trim()) {
                 markInvalid(input, 'This field is required');
                 isValid = false;
             } else {
                 clearInvalid(input); // Clear previous errors if field is now valid
             }
        });

        // Validate the hidden lead generator input (which is required)
        // Check if the value is empty or not a valid JSON string
        if (!generatorDataInput || !generatorDataInput.value || !generatorDataInput.value.startsWith('{')) { // Added check for element existence
             if (generatorSearchInput) markInvalid(generatorSearchInput, 'Please select a Lead Generator from the list'); // Mark the visible search input as invalid
             isValid = false;
        } else {
             // Attempt to parse JSON to ensure it's valid
             try {
                 const parsedData = JSON.parse(generatorDataInput.value);
                 // Additional check: ensure the displayed name matches the hidden data
                 if (generatorSearchInput && generatorSearchInput.value !== parsedData.username) {
                     markInvalid(generatorSearchInput, 'Selected generator does not match input. Please re-select from the list.');
                     isValid = false;
                 } else if (generatorSearchInput) {
                     clearInvalid(generatorSearchInput); // Clear error on the visible input if hidden input is valid and matches
                 }
             } catch (jsonError) {
                 console.error("Invalid JSON in lead generator data:", generatorDataInput.value, jsonError);
                 if (generatorSearchInput) markInvalid(generatorSearchInput, 'Invalid generator data selected');
                 isValid = false;
             }
        }

        // If all validations pass, submit the form using the generic handler
        if (isValid) {
            console.log("Lead form validation passed. Submitting...");
            // The hidden input 'leadgenerator' now holds the JSON string
            // The generic handleFormSubmit will collect this hidden input correctly
            handleFormSubmit(this, '/add-lead', 'Add Lead', 'Lead Added!');
        } else {
            console.log("Lead form validation failed.");
            showNotification("Please correct the errors in the form.", "error"); // Added user notification
        }
    });
    console.log("Add Lead form initialized.");
}


/**
 * Initializes the "Add Product" form.
 * Handles form submission: performs validation on all required fields,
 * then calls the generic form submission handler.
 */
function initializeProductForm() {
    const productForm = document.getElementById('add-product-form');
    if (!productForm) {
        console.error("Add Product form (#add-product-form) not found.");
        return; // Exit if the form doesn't exist
    }

    // Add submit event listener to the form
    productForm.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default browser submission
        let isValid = true; // Flag to track overall form validity
        const requiredInputs = this.querySelectorAll('[required]'); // Get all required fields

        // Validate all required fields
        requiredInputs.forEach(input => {
            if (!input.value.trim()) {
                markInvalid(input, 'This field is required');
                isValid = false;
            } else {
                clearInvalid(input); // Clear any previous error state
            }
        });

        // If all validations pass, submit the form using the generic handler
        if (isValid) {
            console.log("Product form validation passed. Submitting...");
            handleFormSubmit(this, '/add-product', 'Add Product', 'Product Added!');
        } else {
            console.log("Product form validation failed.");
        }
    });
    console.log("Add Product form initialized.");
}


/**
 * Initializes the "Add User" form.
 * Sets up input validation listeners (email, mobile) on blur.
 * Populates the Role and Team dropdowns asynchronously.
 * Handles form submission: performs validation on all required fields (including selects),
 * specific format validations (email, mobile), then calls the generic form submission handler.
 */
function initializeUserForm() {
    const userForm = document.getElementById('add-user-form');
    if (!userForm) {
        console.error("Add User form (#add-user-form) not found.");
        return; // Exit if the form doesn't exist
    }

    // Get references to specific input fields for validation
    const emailInput = document.getElementById('user-email');
    const mobileInput = document.getElementById('user-mobile');

    // Add blur event listeners for real-time format validation
    if (emailInput) emailInput.addEventListener('blur', () => validateEmail(emailInput));
    if (mobileInput) mobileInput.addEventListener('blur', () => validateMobile(mobileInput));

    // Populate Role and Team dropdowns by fetching data from the server
    populateDropdown('user-role', '/get-roles');
    populateDropdown('user-team', '/get-teams');

    // Add submit event listener to the form
    userForm.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default browser submission
        let isValid = true; // Flag to track overall form validity
        const requiredInputs = this.querySelectorAll('[required]'); // Get all required fields

        // Validate all required fields (inputs and selects)
        requiredInputs.forEach(input => {
            if (input.tagName === 'SELECT' && input.value === '') {
                // Special handling for required select dropdowns
                markInvalid(input, 'Please select an option');
                isValid = false;
            } else if (input.tagName !== 'SELECT' && !input.value.trim()) {
                // Handling for required text/email/password/tel inputs
                markInvalid(input, 'This field is required');
                isValid = false;
            } else {
                // If required field is filled/selected, clear potential previous error
                clearInvalid(input);
                // Perform specific format validation only if the field is not empty
                if (input.id === 'user-email' && !validateEmail(input)) isValid = false;
                if (input.id === 'user-mobile' && !validateMobile(input)) isValid = false;
                // Add other specific validations here if needed (e.g., password complexity)
            }
        });

        // If all validations pass, submit the form using the generic handler
        if (isValid) {
            console.log("User form validation passed. Submitting...");
            // Note: Endpoint '/add-users' might differ from typical REST naming conventions (e.g., /users)
            handleFormSubmit(this, '/add-users', 'Add User', 'User Added Successfully!');
        } else {
            console.log("User form validation failed.");
        }
    });
    console.log("Add User form initialized.");
}


/**
 * Generic handler for submitting modal forms via Fetch API.
 * Handles button state (text, disabled, spinner), collects form data,
 * sends POST request, processes JSON response, shows success/error notifications,
 * closes the modal on success, and resets the form.
 * @param {HTMLFormElement} formElement - The form element being submitted.
 * @param {string} endpoint - The API endpoint URL to submit the data to.
 * @param {string} buttonTextDefault - The default text for the submit button.
 * @param {string} buttonTextSuccess - The text to display on the button upon successful submission.
 * @param {string} [successField='success'] - The field name in the JSON response indicating success (defaults to 'success').
 */
function handleFormSubmit(formElement, endpoint, buttonTextDefault, buttonTextSuccess, successField = 'success') {
    const submitBtn = formElement.querySelector('button[type="submit"]');
    // Use optional chaining in case span or spinner elements are missing
    const submitText = submitBtn?.querySelector('span');
    const loadingSpinner = submitBtn?.querySelector('.loading-spinner');

    // Store original button text if not already stored
    if (submitBtn && submitText && !submitBtn.dataset.originalText) {
        submitBtn.dataset.originalText = submitText.textContent;
    }

    // Update button state to processing
    if (submitText) submitText.textContent = 'Processing...';
    if (submitBtn) submitBtn.disabled = true;
    if (loadingSpinner) loadingSpinner.style.display = 'inline-block'; // Show spinner

    // Collect form data into a plain object
    const formData = new FormData(formElement);
    const dataObject = {};
    formData.forEach((value, key) => {
        // Basic sanitization or type conversion could happen here if needed
        dataObject[key] = value;
    });

    console.log(`Submitting form data to ${endpoint}:`, dataObject);

    // Perform the fetch request
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            // Add any other required headers like CSRF tokens if necessary
        },
        body: JSON.stringify(dataObject)
    })
    .then(response => {
        // Check response content type before parsing JSON
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.includes("application/json")) {
            // If JSON, parse it and check response.ok
            return response.json().then(data => {
                if (!response.ok) {
                    // Throw error with message from JSON body if available
                    throw new Error(data.message || `Server error: ${response.status}`);
                }
                return data; // Return parsed JSON data for successful responses
            });
        } else if (!response.ok) {
            // If not JSON and not ok, try to get text() for error message
            return response.text().then(text => {
                throw new Error(`Server error: ${response.status} - ${text || 'Non-JSON error response'}`);
            });
        } else {
            // Handle unexpected successful non-JSON responses if necessary
             console.warn("Received successful but non-JSON response.");
             return {}; // Return empty object or handle as appropriate
        }
    })
    .then(data => {
        // Check the success field in the response data
        if (data[successField] === true) {
            console.log(`Form submission to ${endpoint} successful.`);
            // Update button text and style for success indication
            if (submitText) submitText.textContent = buttonTextSuccess;
            if (submitBtn) submitBtn.style.background = 'linear-gradient(135deg, #66BB6A, #43A047)'; // Success green gradient

            // Close modal and reset form after a delay
            setTimeout(() => {
                const modal = formElement.closest('.modal');
                if (modal) closeActiveModal(modal.id); // Use the close function
                // Resetting the form is now handled within the closeModal function's timeout

                // Show success notification
                showNotification(`${buttonTextSuccess}!`, 'success');

                // Special case: Refresh tasks if the signup form was submitted (adjust endpoint if needed)
                if (endpoint === '/add-users') { // Assuming this is the user creation endpoint
                    fetchAndDisplayTasks(); // Refresh task list if adding a user might affect it
                }
            }, 1500); // Delay to show success message on button
        } else {
            // Throw error if the success field is not true
            throw new Error(data.message || `Failed to ${buttonTextDefault.toLowerCase()}`);
        }
    })
    .catch(error => {
        // Handle any errors during fetch or processing
        console.error(`Error during ${buttonTextDefault}:`, error);
        // Restore button to default state
        if (submitText && submitBtn?.dataset.originalText) submitText.textContent = submitBtn.dataset.originalText;
        else if (submitText) submitText.textContent = buttonTextDefault; // Fallback
        if (submitBtn) {
             submitBtn.disabled = false;
             submitBtn.style.background = ''; // Reset background
        }
        if (loadingSpinner) loadingSpinner.style.display = 'none'; // Hide spinner

        // Show error notification to the user
        showNotification(error.message || `Error: Could not ${buttonTextDefault.toLowerCase()}`, 'error');
    });
}


/**
 * Populates a dropdown select element with options fetched from an API endpoint.
 * Assumes the API returns a JSON object with a success flag and a data array.
 * @param {string} selectElementId - The ID of the <select> element to populate.
 * @param {string} endpoint - The API endpoint URL to fetch data from.
 * @param {string} [dataField='data'] - The name of the field in the JSON response containing the array of options.
 */
function populateDropdown(selectElementId, endpoint, dataField = 'data') {
    const selectElement = document.getElementById(selectElementId);
    if (!selectElement) {
        console.error(`Select element #${selectElementId} not found.`);
        return; // Exit if the select element doesn't exist
    }

    // Fetch data from the specified endpoint
    fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' } }) // Assuming POST is required, adjust if GET
    .then(response => {
        if (!response.ok) {
            // If response not OK, try to parse error message, otherwise use status text
            return response.json().catch(() => { // Try parsing JSON error first
                 throw new Error(`HTTP error! Status: ${response.status} ${response.statusText}`);
            }).then(errData => {
                 throw new Error(errData.message || `HTTP error! Status: ${response.status}`);
            });
        }
        return response.json(); // Parse JSON for successful responses
    })
    .then(data => {
        // Check if the response indicates success and contains the expected data array
        if (data.success && Array.isArray(data[dataField])) {
            console.log(`Populating dropdown #${selectElementId} with data from ${endpoint}`);
            // Preserve the first option (usually a placeholder like "Select Role")
            const placeholder = selectElement.options[0];
            selectElement.innerHTML = ''; // Clear existing options (except placeholder)
            if (placeholder) {
                 selectElement.appendChild(placeholder); // Re-add placeholder if it existed
                 placeholder.selected = true; // Ensure placeholder is selected initially
                 placeholder.disabled = true; // Keep placeholder disabled
            }

            // Add new options from the fetched data
            data[dataField].forEach(item => {
                const option = document.createElement('option');
                // Assuming the item itself is the value and text; adjust if data structure is different (e.g., item.id, item.name)
                option.value = item;
                option.textContent = item;
                selectElement.appendChild(option);
            });
        } else {
            // Log error if data format is incorrect or success flag is false
            console.error(`Failed to fetch or parse valid data for ${selectElementId}:`, data);
            // Optionally add an error message option to the dropdown
             const errorOption = document.createElement('option');
             errorOption.value = "";
             errorOption.textContent = "Error loading";
             errorOption.disabled = true;
             selectElement.appendChild(errorOption);
        }
    })
    .catch(error => {
        // Handle fetch errors (network issues, etc.)
        console.error(`Error fetching data for ${selectElementId} from ${endpoint}:`, error);
        // Add an error message option to the dropdown
        const errorOption = document.createElement('option');
        errorOption.value = "";
        errorOption.textContent = "Error loading options";
        errorOption.disabled = true;
        // Clear existing options before adding error message
        const placeholder = selectElement.options[0];
        selectElement.innerHTML = '';
        if(placeholder) selectElement.appendChild(placeholder); // Keep placeholder if exists
        selectElement.appendChild(errorOption);
    });
}

/**
 * Specifically populates the user role dropdown by calling populateDropdown.
 */
function populateRoles() {
    console.log("Populating roles dropdown...");
    populateDropdown('user-role', '/get-roles'); // Assumes endpoint '/get-roles' returns { success: true, data: ["Role1", "Role2"] }
}

/**
 * Specifically populates the user team dropdown by calling populateDropdown.
 */
function populateTeams() {
    console.log("Populating teams dropdown...");
    populateDropdown('user-team', '/get-teams'); // Assumes endpoint '/get-teams' returns { success: true, data: ["TeamA", "TeamB"] }
}


/**
 * Marks a form input field as invalid and displays an error message.
 * Adds the 'invalid' class to the input and makes the associated error message element visible.
 * If the error message element doesn't exist, it creates one.
 * @param {HTMLElement} input - The input element (or select/textarea) to mark as invalid.
 * @param {string} message - The error message to display.
 */
function markInvalid(input, message) {
    input.classList.add('invalid'); // Add invalid class for styling
    const formGroup = input.closest('.form-group'); // Find the parent form group
    let errorMessage = formGroup ? formGroup.querySelector('.error-message') : null; // Find the error message container within the group

    // If no error message container exists, create one dynamically
    if (!errorMessage) {
        console.warn("No .error-message element found in form-group for input:", input);
        errorMessage = document.createElement('div');
        errorMessage.className = 'error-message';
        // Try to insert after the input wrapper, or fallback to inserting after the input itself
        const wrapper = input.closest('.input-wrapper') || input;
        wrapper.parentNode.insertBefore(errorMessage, wrapper.nextSibling);
    }

    // Set the error message text and make it visible
    errorMessage.textContent = message;
    // Force reflow to ensure the transition is applied correctly when adding the 'visible' class
    errorMessage.offsetHeight;
    errorMessage.classList.add('visible');
}

/**
 * Clears the invalid state from a form input field.
 * Removes the 'invalid' class and hides the associated error message.
 * @param {HTMLElement} input - The input element (or select/textarea) to clear.
 */
function clearInvalid(input) {
    input.classList.remove('invalid'); // Remove invalid class
    const formGroup = input.closest('.form-group'); // Find parent form group
    const errorMessage = formGroup ? formGroup.querySelector('.error-message.visible') : null; // Find the *visible* error message

    // If a visible error message exists, hide it and clear its text
    if (errorMessage) {
        errorMessage.classList.remove('visible');
        // Optionally delay clearing text until after transition for smoother visual effect
        // errorMessage.addEventListener('transitionend', () => { errorMessage.textContent = ''; }, { once: true });
        errorMessage.textContent = ''; // Clear text immediately
    }
}


/**
 * Displays a slide-in notification message at the top right of the screen.
 * Creates the notification container if it doesn't exist.
 * Automatically removes the notification after a set duration.
 * @param {string} message - The message to display in the notification.
 * @param {string} [type='info'] - The type of notification ('info', 'success', 'error'), which affects styling and icon.
 */
function showNotification(message, type = 'info') {
    // Find the notification container, or create it if it doesn't exist
    let notificationContainer = document.querySelector('.notifications-container');
    if (!notificationContainer) {
        console.log("Notification container not found, creating one.");
        notificationContainer = document.createElement('div');
        notificationContainer.className = 'notifications-container';
        document.body.appendChild(notificationContainer);
    }

    // Create the notification element
    const notification = document.createElement('div');
    notification.className = `notification ${type}`; // Base class + type class (e.g., 'notification success')

    // Determine the Font Awesome icon based on the notification type
    let icon = 'info-circle'; // Default icon
    if (type === 'success') icon = 'check-circle';
    if (type === 'error') icon = 'exclamation-circle';
    // Add more types/icons here if needed (e.g., 'warning' with 'exclamation-triangle')

    // Set the inner HTML of the notification, including the icon and escaped message
    notification.innerHTML = `
        <div class="notification-icon">
            <i class="fas fa-${icon}"></i>
        </div>
        <div class="notification-content">
            ${escapeHtml(message)} <!-- Ensure message content is safe -->
        </div>
    `;

    // Add the new notification to the container
    notificationContainer.appendChild(notification);

    // Use requestAnimationFrame to ensure the element is in the DOM before adding the 'show' class for the transition
    requestAnimationFrame(() => {
        notification.classList.add('show');
    });

    // Set a timeout to automatically remove the notification after 5 seconds
    setTimeout(() => {
        notification.classList.remove('show'); // Start the slide-out animation
        // Add an event listener to remove the element from the DOM after the transition completes
        notification.addEventListener('transitionend', () => {
            notification.remove();
        }, { once: true }); // Use { once: true } to automatically remove the listener after it fires
    }, 5000); // 5000 milliseconds = 5 seconds
}


/**
 * Adds click listeners to calendar icons within input wrappers.
 * When a calendar icon is clicked, it attempts to trigger the native date picker
 * for the associated date input field using `showPicker()`.
 * Includes error handling for browsers that don't support `showPicker()`.
 */
function addDateIconListener() {
    console.log("Adding date icon listeners...");
    // Select all elements that are calendar icons within an input wrapper
    document.querySelectorAll('.input-wrapper .input-icon.fa-calendar').forEach(icon => {
        icon.addEventListener('click', () => {
            // Find the preceding sibling element, assuming it's the date input
            const dateInput = icon.previousElementSibling;
            // Check if the preceding element exists and is a date input
            if (dateInput && dateInput.type === 'date') {
                try {
                    // Attempt to programmatically open the date picker
                    dateInput.showPicker();
                    console.log(`Triggered date picker for input: ${dateInput.id || 'no id'}`);
                } catch (error) {
                    // Log an error if showPicker() is not supported or fails
                    console.error("Browser doesn't support showPicker() or another error occurred:", error);
                    // Optionally, provide fallback behavior or user feedback here
                }
            } else {
                 console.warn("Could not find associated date input for calendar icon:", icon);
            }
        });
    });
}


/**
 * Initializes the functionality for the pending tasks carousel.
 * Handles arrow button clicks for scrolling, updates arrow visibility/disabled state
 * based on scroll position and content changes, and responds to window resizing.
 */
function initializeTaskCarousel() {
    const container = document.getElementById('tasks-list-container'); // The scrollable container for task cards
    const leftArrow = document.getElementById('task-arrow-left');     // The left scroll arrow button
    const rightArrow = document.getElementById('task-arrow-right');   // The right scroll arrow button

    // Exit if any essential elements are missing
    if (!container || !leftArrow || !rightArrow) {
        console.warn("Task carousel elements (container or arrows) not found. Cannot initialize.");
        return;
    }

    const scrollAmount = container.clientWidth * 0.8; // Scroll by 80% of the visible width for a smoother feel

    /**
     * Updates the visibility and disabled state of the carousel arrows
     * based on the current scroll position and whether the content is scrollable.
     */
    function updateArrowState() {
        // Use a small tolerance to handle potential sub-pixel rendering issues
        const tolerance = 5;
        const maxScrollLeft = container.scrollWidth - container.clientWidth;

        // Disable left arrow if scrolled to the beginning (within tolerance)
        leftArrow.classList.toggle('disabled', container.scrollLeft <= tolerance);
        // Disable right arrow if scrolled to the end (within tolerance)
        rightArrow.classList.toggle('disabled', container.scrollLeft >= maxScrollLeft - tolerance);

        // Hide arrows entirely if the content doesn't overflow the container
        const isScrollable = container.scrollWidth > container.clientWidth + tolerance; // Add tolerance here too
        const displayStyle = isScrollable ? 'flex' : 'none';
        leftArrow.style.display = displayStyle;
        rightArrow.style.display = displayStyle;
    }

    // Event listener for the left arrow click
    leftArrow.addEventListener('click', () => {
        container.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        // Optionally update state immediately after initiating scroll for better responsiveness
        // setTimeout(updateArrowState, 50); // Update slightly after scroll starts
    });

    // Event listener for the right arrow click
    rightArrow.addEventListener('click', () => {
        container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        // Optionally update state immediately
        // setTimeout(updateArrowState, 50);
    });

    // Debounced scroll event listener to update arrows after scrolling stops
    let scrollTimeout;
    container.addEventListener('scroll', () => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(updateArrowState, 150); // Update arrows 150ms after scroll stops
    }, { passive: true }); // Use passive listener for scroll performance

    // Update arrow state on window resize
    window.addEventListener('resize', updateArrowState, { passive: true });

    // Use MutationObserver to detect when task cards are added or removed
    const observer = new MutationObserver(mutations => {
        // Check if any mutation involved adding/removing child nodes
        let relevantChange = mutations.some(mutation => mutation.type === 'childList');
        if (relevantChange) {
            console.log("Task list changed, updating carousel arrow state.");
            // Update state slightly after the DOM change settles
            setTimeout(updateArrowState, 50);
        }
    });
    // Observe the task container for changes in its direct children
    observer.observe(container, { childList: true });

    // Initial update of arrow state when the page loads
    // Use setTimeout to ensure layout calculations are complete
    setTimeout(updateArrowState, 150);
    console.log("Task carousel initialized.");
}


/**
 * Initializes the expand/collapse functionality for the pending tasks section.
 * Toggles the 'expanded' class on the section and updates the button text.
 * Also hides/shows carousel arrows based on the expanded state.
 */
function initializeTaskExpandCollapse() {
    const expandBtn = document.getElementById('expand-tasks-btn');     // The expand/collapse button
    const tasksSection = document.getElementById('tasks-section');   // The tasks section element
    const btnTextSpan = expandBtn?.querySelector('span');             // The text span within the button

    // Exit if essential elements are missing
    if (!expandBtn || !tasksSection || !btnTextSpan) {
        console.warn("Task expand/collapse elements (button, section, or button text span) not found.");
        return;
    }

    // Add click listener to the expand/collapse button
    expandBtn.addEventListener('click', () => {
        // Toggle the 'expanded' class on the tasks section
        const isExpanded = tasksSection.classList.toggle('expanded');
        // Update the button text accordingly
        btnTextSpan.textContent = isExpanded ? 'Collapse' : 'Expand';
        console.log(`Tasks section ${isExpanded ? 'expanded' : 'collapsed'}.`);

        // Update carousel arrow visibility immediately after toggling expand/collapse
        // Use setTimeout with 0ms delay to allow the DOM to update slightly before checking scroll state
        setTimeout(() => {
            const container = document.getElementById('tasks-list-container');
            const leftArrow = document.getElementById('task-arrow-left');
            const rightArrow = document.getElementById('task-arrow-right');

            if (container && leftArrow && rightArrow) {
                // Arrows should only be visible if the container is scrollable AND not expanded
                const isScrollable = !isExpanded && container.scrollWidth > container.clientWidth;
                const displayStyle = isScrollable ? 'flex' : 'none';
                leftArrow.style.display = displayStyle;
                rightArrow.style.display = displayStyle;

                // If collapsing back to carousel view, re-check arrow disabled state
                if (!isExpanded && isScrollable) {
                    const tolerance = 5;
                    leftArrow.classList.toggle('disabled', container.scrollLeft <= tolerance);
                    rightArrow.classList.toggle('disabled', container.scrollLeft + container.clientWidth >= container.scrollWidth - tolerance);
                }
            }
        }, 0); // Delay of 0ms allows browser to repaint before checking scroll state
    });
    console.log("Task expand/collapse functionality initialized.");
}



/**
 * Populates the assignee dropdown in the "Assign Task" modal.
 * Fetches user data (ID and username) from the '/get-users' endpoint.
 * Assumes the endpoint returns { success: true, data: [{id: '...', username: '...'}, ...] }
 * Handles success, failure, and error cases during the fetch operation.
 */
function populateAssigneeDropdown() {
    const selectElement = document.getElementById('task-assignee');
    if (!selectElement) {
        console.error("Assignee select element (#task-assignee) not found.");
        return; // Exit if the dropdown element doesn't exist
    }

    console.log("Populating assignee dropdown...");

    // Fetch user data from the backend
    fetch('/get-users', {
        method: 'POST', // Assuming POST is required, adjust if GET
        headers: { 'Content-Type': 'application/json' },
        // No body needed if just fetching all users
    })
    .then(response => {
        // Handle non-OK responses (e.g., 404, 500)
        if (!response.ok) {
            // Try to parse JSON error message, otherwise use status text
            return response.json().catch(() => {
                throw new Error(`HTTP error! Status: ${response.status} ${response.statusText}`);
            }).then(errData => {
                throw new Error(errData.message || `HTTP error! Status: ${response.status}`);
            });
        }
        return response.json(); // Parse JSON for successful responses
    })
    .then(data => {
        console.log("Fetched users for dropdown:", data);
        // Check if the response indicates success and contains the user data array
        if (data.success && Array.isArray(data.data)) {
            // Preserve the first option (placeholder)
            const placeholder = selectElement.options[0];
            selectElement.innerHTML = ''; // Clear existing options
            if (placeholder) {
                selectElement.appendChild(placeholder); // Re-add placeholder
                placeholder.selected = true;
                placeholder.disabled = true;
            }

            // Add new options for each fetched user
            data.data.forEach(user => {
                // Ensure user object has expected properties
                if (user && user.id && user.username) {
                    const option = document.createElement('option');
                    option.value = user.id;         // Set option value to user ID
                    option.textContent = user.username; // Set option text to username
                    selectElement.appendChild(option);
                } else {
                    console.warn("Skipping user with invalid data:", user);
                }
            });
            console.log(`Successfully populated assignee dropdown with ${data.data.length} users.`);
        } else {
            // Log error if data format is incorrect or success is false
            console.error("Failed to fetch or parse valid user data:", data);
            throw new Error(data.message || "Invalid data format received for users.");
        }
    })
    .catch(error => {
        // Handle fetch errors or errors thrown from the .then() blocks
        console.error("Error fetching users for dropdown:", error);
        // Display an error message in the dropdown
        const errorOption = document.createElement('option');
        errorOption.value = "";
        errorOption.textContent = "Error loading users";
        errorOption.disabled = true;

        // Clear existing options and add placeholder + error option
        const placeholder = selectElement.options[0];
        selectElement.innerHTML = '';
        if (placeholder) selectElement.appendChild(placeholder);
        selectElement.appendChild(errorOption);
        // Optionally show a user-facing notification
        // showNotification(`Error loading assignees: ${error.message}`, 'error');
    });
}

/**
 * Initializes the "Assign Task" form.
 * Sets up validation for the due date input on blur.
 * Adds a change listener to the assignee dropdown for logging.
 * Handles form submission: validates required fields, collects task data,
 * sends it to the '/assign-task' endpoint, and handles the response.
 */
function initializeAssignTaskForm() {
    const assignTaskForm = document.getElementById('assign-task-form');
    if (!assignTaskForm) {
        console.error("Assign Task form (#assign-task-form) not found.");
        return; // Exit if form doesn't exist
    }

    // --- Input Validation Setup ---
    const dueDateInput = document.getElementById('task-due-date');
    if (dueDateInput) {
        // Validate due date on blur (check if required and empty)
        dueDateInput.addEventListener('blur', () => {
            if (dueDateInput.value === '' && dueDateInput.hasAttribute('required')) {
                markInvalid(dueDateInput, 'Due date is required');
            } else {
                clearInvalid(dueDateInput);
            }
        });
    }

    // --- Assignee Dropdown Change Listener (for logging/debugging) ---
    const assigneeSelect = document.getElementById('task-assignee');
    if (assigneeSelect) {
        assigneeSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption && selectedOption.value) {
                const userId = selectedOption.value;
                const userName = selectedOption.textContent;
                console.log(`Assignee Changed - ID: ${userId}, Name: ${userName}`);
            } else {
                console.log("Assignee selection cleared or placeholder selected.");
            }
        });
    } else {
        console.warn("Assignee select element (#task-assignee) not found during listener setup.");
    }

    // --- Form Submission Handler ---
    assignTaskForm.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default form submission
        let isValid = true; // Flag for overall form validity
        const requiredInputs = this.querySelectorAll('[required]'); // Get all required fields

        // Validate all required fields (inputs and selects)
        requiredInputs.forEach(input => {
            if (input.tagName === 'SELECT' && input.value === '') {
                markInvalid(input, 'Please select an option');
                isValid = false;
            } else if (input.tagName !== 'SELECT' && !input.value.trim()) {
                markInvalid(input, 'This field is required');
                isValid = false;
            } else {
                clearInvalid(input); // Clear previous errors if field is now valid
            }
        });

        // Proceed only if all required fields are valid
        if (isValid) {
            console.log("Assign Task form validation passed. Submitting...");
            // Get button elements and current user ID
            const submitBtn = this.querySelector('button[type="submit"]');
            const submitText = submitBtn?.querySelector('span');
            const loadingSpinner = submitBtn?.querySelector('.loading-spinner');
            const assignerId = document.getElementById('user-id')?.value; // Use optional chaining

            if (!assignerId) {
                 console.error("Assigner User ID not found. Cannot assign task.");
                 showNotification("Error: Could not identify assigner.", "error");
                 return; // Stop submission if assigner ID is missing
            }

            // Store original button text if not already stored
            if (submitBtn && submitText && !submitBtn.dataset.originalText) {
                submitBtn.dataset.originalText = submitText.textContent;
            }

            // Update button state to processing
            if (submitText) submitText.textContent = 'Assigning...';
            if (submitBtn) submitBtn.disabled = true;
            if (loadingSpinner) loadingSpinner.style.display = 'inline-block'; // Show spinner

            // Get selected assignee details
            const selectedAssigneeOption = assigneeSelect.options[assigneeSelect.selectedIndex];
            const assigneeName = selectedAssigneeOption ? selectedAssigneeOption.textContent : '';

            // Prepare data payload for the API
            const dataObject = {
                'task_title': document.getElementById('task-title').value,
                'task_description': document.getElementById('task-description').value,
                'due_date': dueDateInput.value, // Use the variable defined earlier
                'assigned_to': assigneeSelect.value,
                'assigned_to_name': assigneeName,
                'assigned_by': assignerId,
                'status': 'In Progress' // Default status for new tasks
            };

            console.log("Assigning Task with data:", dataObject);

            // --- Fetch API Call ---
            fetch('/assign-task', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataObject)
            })
            .then(response => {
                // Handle response, checking for JSON and OK status
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    return response.json().then(data => {
                         if (!response.ok) throw new Error(data.message || `Server error: ${response.status}`);
                         return data;
                    });
                } else if (!response.ok) {
                    return response.text().then(text => { throw new Error(`Server error: ${response.status} - ${text || 'Non-JSON error'}`); });
                } else {
                     throw new Error("Received unexpected non-JSON response from server");
                }
            })
            .then(data => {
                // Handle successful API response
                if (data.success === true) {
                    console.log("Task assigned successfully via API.");
                    if (submitText) submitText.textContent = 'Task Assigned!';
                    if (submitBtn) submitBtn.style.background = 'linear-gradient(135deg, #66BB6A, #43A047)'; // Success green

                    // Close modal and reset form after delay
                    setTimeout(() => {
                        const modal = this.closest('.modal');
                        if (modal) closeActiveModal(modal.id); // Use helper function

                        // Resetting form and button state is handled by closeActiveModal's listener

                        showNotification('Task Assigned Successfully!', 'success');
                        fetchAndDisplayTasks(); // Refresh the pending task list
                    }, 1500); // Delay to show success message
                } else {
                    // Handle API indicating failure
                    throw new Error(data.message || 'Failed to assign task');
                }
            })
            .catch(error => {
                // Handle fetch errors or errors thrown in .then blocks
                console.error('Error assigning task:', error);
                // Restore button state
                if (submitText && submitBtn?.dataset.originalText) submitText.textContent = submitBtn.dataset.originalText;
                else if (submitText) submitText.textContent = 'Assign Task'; // Fallback
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.style.background = '';
                }
                if (loadingSpinner) loadingSpinner.style.display = 'none'; // Hide spinner

                showNotification(error.message || 'Error: Could not assign task', 'error');
            });
        } else {
             console.log("Assign Task form validation failed.");
        }
    });
    console.log("Assign Task form initialized.");
}


/**
 * Initializes the refresh button for the pending tasks list.
 * Adds a click listener that triggers fetching and displaying tasks,
 * provides visual feedback (spinning icon), and temporarily disables the button.
 */
function initializeRefreshButton() {
    const refreshButton = document.getElementById('refresh-tasks-btn'); // Get the refresh button element

    // Exit if the button element is not found
    if (!refreshButton) {
        console.error("Refresh button (#refresh-tasks-btn) not found.");
        return;
    }

    // Add click event listener to the refresh button
    refreshButton.addEventListener('click', () => {
        console.log("Refresh tasks button clicked.");
        const icon = refreshButton.querySelector('i'); // Get the icon element within the button

        // Provide visual feedback and disable the button
        if (icon) icon.classList.add('spinning'); // Add spinning class to the icon
        refreshButton.disabled = true;            // Disable the button to prevent multiple clicks

        // Call the function to fetch and display the updated task list
        fetchAndDisplayTasks();

        // Re-enable the button and remove spinning class after a short delay
        // This delay ensures the user sees the spinning icon, even if the fetch is very fast.
        // Note: Ideally, this would be tied to the completion of fetchAndDisplayTasks,
        // but for simplicity, a fixed timeout is used here.
        setTimeout(() => {
            if (icon) icon.classList.remove('spinning'); // Remove spinning class
            refreshButton.disabled = false;            // Re-enable the button
            console.log("Refresh button re-enabled.");
        }, 1000); // 1 second delay
    });

    console.log("Refresh tasks button initialized.");
}

</script>
<style>

#task-details-modal.history-unavailable .task-history-column {
    display: none;
}
#task-details-modal.history-unavailable .task-details-column {
    max-width: 100%;
    width: 100%;
    padding-right: 0; 
    border-right: none; 
}
</style>
</body>
</html>